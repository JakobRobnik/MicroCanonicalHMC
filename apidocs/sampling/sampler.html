<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>sampling.sampler API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Target">Target</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Target.__init__">Target</a>
                        </li>
                        <li>
                                <a class="variable" href="#Target.d">d</a>
                        </li>
                        <li>
                                <a class="variable" href="#Target.nlogp">nlogp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Target.grad_nlogp">grad_nlogp</a>
                        </li>
                        <li>
                                <a class="function" href="#Target.transform">transform</a>
                        </li>
                        <li>
                                <a class="function" href="#Target.prior_draw">prior_draw</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Sampler">Sampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Sampler.__init__">Sampler</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.sigma">sigma</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.dynamics">dynamics</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.random_unit_vector">random_unit_vector</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.diagonal_preconditioning">diagonal_preconditioning</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.frac_tune1">frac_tune1</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.frac_tune2">frac_tune2</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.frac_tune3">frac_tune3</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.varEwanted">varEwanted</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.gamma">gamma</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.sigma_xi">sigma_xi</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sampler.Lfactor">Lfactor</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.nan_reject">nan_reject</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.dynamics_adaptive">dynamics_adaptive</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.get_initial_conditions">get_initial_conditions</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample">sample</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.single_chain_sample">single_chain_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample_normal">sample_normal</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample_thinning">sample_thinning</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample_expectation">sample_expectation</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample_ess">sample_ess</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.tune12">tune12</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.tune3">tune3</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.sample_full">sample_full</a>
                        </li>
                        <li>
                                <a class="function" href="#Sampler.bias_plot">bias_plot</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#find_crossing">find_crossing</a>
            </li>
            <li>
                    <a class="function" href="#point_reduction">point_reduction</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
sampling<wbr>.sampler    </h1>

                
                        <input id="mod-sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-sampler-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1">## style note: general preference here for functional style (e.g. global function definitions, purity, code sharing)</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">jax</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">dynamics</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">.correlation_length</span> <span class="kn">import</span> <span class="n">ess_corr</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="k">class</span> <span class="nc">Target</span><span class="p">():</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;#Class for target distribution</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">  </span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">  E.g. </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">  </span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">  ```python</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">  Target(d=2, nlogp = lambda x: 0.5*jnp.sum(jnp.square(x)))</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">```</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">  defines a Gaussian.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">  </span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nlogp</span><span class="p">):</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;dimensionality of the target distribution&quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span> <span class="o">=</span> <span class="n">nlogp</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; negative log probability of target distribution (i.e. energy function)&quot;&quot;&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grad_nlogp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; function which computes nlogp and its gradient&quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; a transformation of the samples from the target distribution&quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="k">return</span> <span class="n">x</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>  <span class="k">def</span> <span class="nf">prior_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;**Args**: jax random key</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">       </span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">       **Returns**: one random sample from the prior</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="n">OutputType</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;Output&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="s1">&#39;expectation&#39;</span><span class="p">,</span> <span class="s1">&#39;ess&#39;</span><span class="p">])</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">&quot;&quot;&quot; @private &quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="k">class</span> <span class="nc">Sampler</span><span class="p">:</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;the MCHMC (q = 0 Hamiltonian) sampler&quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>                 <span class="n">Target</span> <span class="p">:</span> <span class="n">Target</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>                 <span class="n">L</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>                 <span class="n">integrator</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">minimal_norm</span><span class="p">,</span> <span class="n">varEwanted</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>                 <span class="n">diagonal_preconditioning</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>                 <span class="n">frac_tune1</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune3</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>                 <span class="p">):</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">                Target: the target distribution class</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">                **L**: momentum decoherence scale (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting frac_tune2 and 3 to zero (see below))</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">                **eps**: initial integration step-size (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting all frac_tune1 and 2 to zero (see below))</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">                **integrator**: dynamics.leapfrog or dynamics.minimal_norm. Typically minimal_norm performs better.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">                **varEwanted**: if your posteriors are biased try smaller values (or larger values: perhaps the convergence is too slow). This is perhaps the parameter whose default value is the least well determined.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">                **diagonal_preconditioning**: if you already have your own preconditioning or if you suspect diagonal preconditioning is not useful, turn this off as it can also make matters worse</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">                                          (but it can also be very useful if you did not precondition the parameters (make their posterior variances close to 1))</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">                **frac_tune1**: (num_samples * frac_tune1) steps will be used as a burn-in and to autotune the stepsize</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">                **frac_tune2**: (num_samples * frac_tune2) steps will be used to autotune L (should be around 10 effective samples long for the optimal performance)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">                **frac_tune3**: (num_samples * frac_tune3) steps will be used to improve the L tuning (should be around 10 effective samples long for the optimal performance). This stage is not neccessary if the posterior is close to a Gaussian and does not change much in general.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">                            It can be memory intensive in high dimensions so try turning it off if you have problems with the memory.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Target</span> <span class="o">=</span> <span class="n">Target</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;@private&quot;&quot;&quot;</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="c1">### integrator ###</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="n">hamiltonian_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span> <span class="o">=</span> <span class="n">integrator</span><span class="p">(</span><span class="n">T</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">),</span> 
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>                                                                <span class="n">V</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>                                                                <span class="n">d</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span><span class="n">hamiltonian_step</span><span class="p">,</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">partially_refresh_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="c1">### preconditioning ###</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span> <span class="o">=</span> <span class="n">diagonal_preconditioning</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="c1">### autotuning parameters ###</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="c1"># length of autotuning</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">=</span> <span class="n">frac_tune1</span> <span class="c1"># num_samples * frac_tune1 steps will be used to autotune eps</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">=</span> <span class="n">frac_tune2</span> <span class="c1"># num_samples * frac_tune2 steps will be used to approximately autotune L</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">=</span> <span class="n">frac_tune3</span> <span class="c1"># num_samples * frac_tune3 steps will be used to improve L tuning.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span> <span class="o">=</span> <span class="n">varEwanted</span> <span class="c1"># 1e-3 #targeted energy variance Var[E]/d</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="n">neff</span> <span class="o">=</span> <span class="mi">150</span> <span class="c1"># effective number of steps used to determine the stepsize in the adaptive step</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">neff</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># forgeting factor in the adaptive step</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># determines how much do we trust the stepsize predictions from the too large and too small stepsizes</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1">#in the third stage we set L = Lfactor * (configuration space distance bewteen independent samples)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1">### default eps and L ###</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#default value (works if the target is well preconditioned). If you are not happy with the default value and have not run the grid search we suggest using the autotuning</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="k">if</span> <span class="n">eps</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#defualt value (assumes preconditioned target and even then it might not work). Unless you have done a grid search to determine this value we suggest using the autotuning</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">nan_reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if there are nans, let&#39;s reduce the stepsize, and not update the state. The function returns the old state in this case.&quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">nonans</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">nonans</span><span class="p">,</span> <span class="o">*</span><span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonans</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">new</span><span class="p">),</span> <span class="n">old</span><span class="p">),</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="k">def</span> <span class="nf">dynamics_adaptive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;One step of the dynamics with the adaptive stepsize&quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Feps</span><span class="o">/</span><span class="n">Weps</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="c1">#We use the Var[E] = O(eps^6) relation here.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps_max</span>  <span class="c1"># if the proposed stepsize is above the stepsize where we have seen divergences</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="c1"># dynamics</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="c1"># step updating</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">success</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_reject</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">DE</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>  <span class="c1"># energy difference</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">DE</span>  <span class="c1"># energy</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="c1"># Warning: var = 0 if there were nans, but we will give it a very small weight</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">((</span><span class="n">DE</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-8</span>  <span class="c1"># 1e-8 is added to avoid divergences in log xi</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="p">)))</span>  <span class="c1"># the weight which reduces the impact of stepsizes which are much larger on much smaller than the desired one.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">Feps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Feps</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>  <span class="c1"># Kalman update the linear combinations</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">Weps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Weps</span> <span class="o">+</span> <span class="n">w</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">success</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="c1">### sampling routine ###</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="nf">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">):</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="c1">### random key ###</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="n">key</span><span class="p">,</span> <span class="n">prior_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="n">x_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">prior_key</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">l</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="c1">#u = - g / jnp.sqrt(jnp.sum(jnp.square(g))) #initialize momentum in the direction of the gradient of log p</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="k">return</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_initial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">random_key</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">thinning</span><span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">               num_steps: number of integration steps to take.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">               num_chains: number of independent chains, defaults to 1. If different than 1, jax will parallelize the computation with the number of available devices (CPU, GPU, TPU),</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">               as returned by jax.local_device_count().</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">               x_initial: initial condition for x, shape: (d, ). Defaults to None in which case the initial condition is drawn from the prior distribution (self.Target.prior_draw).</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">               random_key: jax random seed, defaults to jax.random.PRNGKey(0)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">               output: determines the output of the function:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">                        &#39;normal&#39;: samples, burn in steps.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">                            samples were transformed by the Target.transform to save memory and have shape: (num_samples, len(Target.transform(x)))</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">                        &#39;expectation&#39;: exepcted value of transform(x)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">                            most memory efficient. If you are after memory it might be usefull to turn off the third tuning stage</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">                        &#39;detailed&#39;: samples, energy error for each step, L and eps used for sampling</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">                        &#39;ess&#39;: Effective Sample Size per gradient evaluation, float.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">                            In this case, self.Target.variance = &lt;x_i^2&gt;_true should be defined.</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">                thinning: only one every &#39;thinning&#39; steps is stored. Defaults to 1.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">                        This is not the recommended solution to save memory. It is better to use the transform functionality.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">                        If this is not sufficient consider saving only the expected values, by setting output= &#39;expectation&#39;.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="k">for</span> <span class="n">ground_truth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;second_moments&#39;</span><span class="p">,</span> <span class="s1">&#39;variance_second_moments&#39;</span><span class="p">]:</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.&quot;</span> <span class="o">+</span> <span class="n">ground_truth</span> <span class="o">+</span> <span class="s2">&quot; should be defined if you want to use output = ess.&quot;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="n">num_chains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span> <span class="c1">#the function which actually does the sampling</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                <span class="k">return</span> <span class="n">results</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">local_device_count</span><span class="p">()</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="n">keys_all</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">keys_all</span><span class="p">[</span><span class="n">num_chains</span><span class="o">+</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)])</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">keys_all</span><span class="p">[:</span><span class="n">num_chains</span><span class="p">]</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#initial x is given</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="k">if</span> <span class="n">num_cores</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#run the chains on parallel cores</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">parallel_function</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">parallel_function</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_cores</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">//</span> <span class="n">num_cores</span><span class="p">))</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_chains</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">))</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="c1">### reshape results ###</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span> <span class="c1">#each chain returned a tuple</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                    <span class="n">results_reshaped</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                        <span class="n">results_reshaped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">))]))</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                    <span class="k">return</span> <span class="n">results_reshaped</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                    <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">))])</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#run chains serially on a single core</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">))</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                    <span class="k">return</span> <span class="n">results</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>    <span class="k">def</span> <span class="nf">single_chain_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;sampling routine. It is called by self.sample&quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_conditions</span><span class="p">(</span><span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="n">L</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="c1">#the initial values, given at the class initialization (or set to the default values)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="c1"># jnp.ones(self.Target.d)  # no diagonal preconditioning</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="c1">### auto-tune the hyperparameters L and eps ###</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">steps1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">steps2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps1</span><span class="p">,</span> <span class="n">steps2</span><span class="p">)</span> <span class="c1">#the cheap tuning (100 steps)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if we want to further improve L tuning we go to the second stage (which is a bit slower)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">steps3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="n">L</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps3</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="c1">### sampling ###</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span> <span class="ow">or</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_normal</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="k">return</span> <span class="n">X</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">expectation</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_expectation</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.variance should be defined&quot;</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ess</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>       
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="c1">### for loops which do the sampling steps: ###</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="k">def</span> <span class="nf">sample_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="c1"># left in as a comment since it may be useful when experimenting with neighbour lists in MD</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="c1"># if self.Target.nbrs:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="c1">#     self.Target.nbrs = self.Target.nbrs.update(jnp.reshape(xx, (-1,3)), neighbor=self.Target.nbrs)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">ll</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">if</span> <span class="n">thinning</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_thinning</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="k">def</span> <span class="nf">sample_thinning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="k">def</span> <span class="nf">substep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">substep</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#do &#39;thinning&#39; steps without saving</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#save one sample</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps</span> <span class="o">//</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="k">def</span> <span class="nf">sample_expectation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores no history but keeps the expected value of transform(x).&quot;&quot;&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="kc">None</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">state1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="n">state2</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="k">return</span>  <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="p">(</span><span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_steps</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">sample_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores the bias of the second moments for each step.&quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state_track</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="n">bias_d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">second_moments</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance_second_moments</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">bias</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bias_d</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="c1">#bias = jnp.max(bias_d)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">bias</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="c1">#nans = jnp.any(jnp.isnan(b))</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">b</span> <span class="c1">#+ nans * 1e5 #return a large bias if there were nans</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>    <span class="c1">### tuning phase: ###</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">tune12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L_given</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma_given</span><span class="p">,</span> <span class="n">num_steps1</span><span class="p">,</span> <span class="n">num_steps2</span><span class="p">):</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;cheap hyperparameter tuning&quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_given</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">outer_weight</span><span class="p">):</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;one adaptive step of the dynamics&quot;&quot;&quot;</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_adaptive</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">outer_weight</span> <span class="o">*</span> <span class="n">eps</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">zero_prevention</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">outer_weight</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="n">F1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F2</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="n">w</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">eps</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">L_given</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="c1"># we use the last num_steps2 to compute the diagonal preconditioner</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="n">outer_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_steps2</span><span class="p">)))</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="c1">#initial state</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="c1"># run the steps</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">outer_weights</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps1</span> <span class="o">+</span> <span class="n">num_steps2</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="c1"># determine L</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="k">if</span> <span class="n">num_steps2</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">variances</span> <span class="o">=</span> <span class="n">F2</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F1</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="c1"># optionally we do the diagonal preconditioning (and readjust the stepsize)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                <span class="c1"># diagonal preconditioning</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                <span class="c1">#readjust the stepsize</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>                <span class="n">steps</span> <span class="o">=</span> <span class="n">num_steps2</span> <span class="o">//</span> <span class="mi">3</span> <span class="c1">#we do some small number of steps</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># the final state</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="c1">#return the tuned hyperparameters and the final state</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="k">def</span> <span class="nf">tune3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;determine L by the autocorrelations (around 10 effective samples are needed for this to be accurate)&quot;&quot;&quot;</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_full</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="n">ESS</span> <span class="o">=</span> <span class="n">ess_corr</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="n">Lnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">/</span> <span class="n">ESS</span> <span class="c1"># = 0.4 * correlation length</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="k">return</span> <span class="n">Lnew</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="k">def</span> <span class="nf">sample_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores full x for each step. Used in tune2.&quot;&quot;&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">xx</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">track</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="n">track</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>    <span class="k">def</span> <span class="nf">bias_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="c1">#bsq = jnp.average(results.reshape(results.shape[0] * results.shape[1], results.shape[2]), axis = 0)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">results</span>    
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="c1"># plt.plot(bsq)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="c1"># plt.plot([0, len(bsq)], np.ones(2) * 0.01, &#39;--&#39;, color = &#39;black&#39;)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="c1"># plt.yscale(&#39;log&#39;)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="c1"># plt.tight_layout()</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="c1"># plt.savefig(&#39;plots/tst_ensemble/sequential/&#39; + self.Target.name + &#39;.png&#39;)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="c1"># plt.close()</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="n">cutoff_reached</span> <span class="o">=</span> <span class="n">bsq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mf">100.</span> <span class="o">/</span> <span class="p">(</span><span class="n">find_crossing</span><span class="p">(</span><span class="n">bsq</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span><span class="p">))</span> <span class="o">*</span> <span class="n">cutoff_reached</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="k">def</span> <span class="nf">find_crossing</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;the smallest M such that array[m] &lt; cutoff for all m &gt; M&quot;&quot;&quot;</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;carry = (, 1 if (array[i] &gt; cutoff for all i &lt; current index) else 0&quot;&quot;&quot;</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">element</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="n">never_been_below</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">above_threshold</span>  <span class="c1">#1 if (array[i] &gt; cutoff for all i &lt; current index) else 0</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">carry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">never_been_below</span><span class="p">,</span> <span class="n">never_been_below</span><span class="p">),</span> <span class="n">above_threshold</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="n">state</span><span class="p">,</span> <span class="n">track</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="c1">#return jnp.sum(track) #total number of indices for which array[m] &lt; cutoff</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="k">def</span> <span class="nf">point_reduction</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="p">):</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;reduces the number of points for plotting purposes&quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_points</span> <span class="o">//</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">num_points</span> <span class="o">//</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)))</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="k">return</span> <span class="n">indexes</span>
</span></pre></div>


            </section>
                <section id="Target">
                            <input id="Target-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Target</span>:

                <label class="view-source-button" for="Target-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Target"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Target-12"><a href="#Target-12"><span class="linenos">12</span></a><span class="k">class</span> <span class="nc">Target</span><span class="p">():</span>
</span><span id="Target-13"><a href="#Target-13"><span class="linenos">13</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;#Class for target distribution</span>
</span><span id="Target-14"><a href="#Target-14"><span class="linenos">14</span></a><span class="sd">  </span>
</span><span id="Target-15"><a href="#Target-15"><span class="linenos">15</span></a><span class="sd">  E.g. </span>
</span><span id="Target-16"><a href="#Target-16"><span class="linenos">16</span></a><span class="sd">  </span>
</span><span id="Target-17"><a href="#Target-17"><span class="linenos">17</span></a><span class="sd">  ```python</span>
</span><span id="Target-18"><a href="#Target-18"><span class="linenos">18</span></a><span class="sd">  Target(d=2, nlogp = lambda x: 0.5*jnp.sum(jnp.square(x)))</span>
</span><span id="Target-19"><a href="#Target-19"><span class="linenos">19</span></a><span class="sd">```</span>
</span><span id="Target-20"><a href="#Target-20"><span class="linenos">20</span></a>
</span><span id="Target-21"><a href="#Target-21"><span class="linenos">21</span></a><span class="sd">  defines a Gaussian.</span>
</span><span id="Target-22"><a href="#Target-22"><span class="linenos">22</span></a><span class="sd">  </span>
</span><span id="Target-23"><a href="#Target-23"><span class="linenos">23</span></a><span class="sd">  &quot;&quot;&quot;</span>
</span><span id="Target-24"><a href="#Target-24"><span class="linenos">24</span></a>
</span><span id="Target-25"><a href="#Target-25"><span class="linenos">25</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nlogp</span><span class="p">):</span>
</span><span id="Target-26"><a href="#Target-26"><span class="linenos">26</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="Target-27"><a href="#Target-27"><span class="linenos">27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;dimensionality of the target distribution&quot;&quot;&quot;</span>
</span><span id="Target-28"><a href="#Target-28"><span class="linenos">28</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span> <span class="o">=</span> <span class="n">nlogp</span>
</span><span id="Target-29"><a href="#Target-29"><span class="linenos">29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; negative log probability of target distribution (i.e. energy function)&quot;&quot;&quot;</span>
</span><span id="Target-30"><a href="#Target-30"><span class="linenos">30</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grad_nlogp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span><span class="p">)</span>
</span><span id="Target-31"><a href="#Target-31"><span class="linenos">31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; function which computes nlogp and its gradient&quot;&quot;&quot;</span>
</span><span id="Target-32"><a href="#Target-32"><span class="linenos">32</span></a>
</span><span id="Target-33"><a href="#Target-33"><span class="linenos">33</span></a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="Target-34"><a href="#Target-34"><span class="linenos">34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; a transformation of the samples from the target distribution&quot;&quot;&quot;</span>
</span><span id="Target-35"><a href="#Target-35"><span class="linenos">35</span></a>    <span class="k">return</span> <span class="n">x</span>
</span><span id="Target-36"><a href="#Target-36"><span class="linenos">36</span></a>
</span><span id="Target-37"><a href="#Target-37"><span class="linenos">37</span></a>  <span class="k">def</span> <span class="nf">prior_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="Target-38"><a href="#Target-38"><span class="linenos">38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;**Args**: jax random key</span>
</span><span id="Target-39"><a href="#Target-39"><span class="linenos">39</span></a><span class="sd">       </span>
</span><span id="Target-40"><a href="#Target-40"><span class="linenos">40</span></a><span class="sd">       **Returns**: one random sample from the prior</span>
</span><span id="Target-41"><a href="#Target-41"><span class="linenos">41</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Target-42"><a href="#Target-42"><span class="linenos">42</span></a>
</span><span id="Target-43"><a href="#Target-43"><span class="linenos">43</span></a>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><h1 id="class-for-target-distribution">Class for target distribution</h1>

<p>E.g. </p>

<p><code>python
  Target(d=2, nlogp = lambda x: 0.5*jnp.sum(jnp.square(x)))
</code></p>

<p>defines a Gaussian.</p>
</div>


                            <div id="Target.__init__" class="classattr">
                                        <input id="Target.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Target</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">d</span>, </span><span class="param"><span class="n">nlogp</span></span>)</span>

                <label class="view-source-button" for="Target.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Target.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Target.__init__-25"><a href="#Target.__init__-25"><span class="linenos">25</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nlogp</span><span class="p">):</span>
</span><span id="Target.__init__-26"><a href="#Target.__init__-26"><span class="linenos">26</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="Target.__init__-27"><a href="#Target.__init__-27"><span class="linenos">27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;dimensionality of the target distribution&quot;&quot;&quot;</span>
</span><span id="Target.__init__-28"><a href="#Target.__init__-28"><span class="linenos">28</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span> <span class="o">=</span> <span class="n">nlogp</span>
</span><span id="Target.__init__-29"><a href="#Target.__init__-29"><span class="linenos">29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; negative log probability of target distribution (i.e. energy function)&quot;&quot;&quot;</span>
</span><span id="Target.__init__-30"><a href="#Target.__init__-30"><span class="linenos">30</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">grad_nlogp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlogp</span><span class="p">)</span>
</span><span id="Target.__init__-31"><a href="#Target.__init__-31"><span class="linenos">31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; function which computes nlogp and its gradient&quot;&quot;&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="Target.d" class="classattr">
                                <div class="attr variable">
            <span class="name">d</span>

        
    </div>
    <a class="headerlink" href="#Target.d"></a>
    
            <div class="docstring"><p>dimensionality of the target distribution</p>
</div>


                            </div>
                            <div id="Target.nlogp" class="classattr">
                                <div class="attr variable">
            <span class="name">nlogp</span>

        
    </div>
    <a class="headerlink" href="#Target.nlogp"></a>
    
            <div class="docstring"><p>negative log probability of target distribution (i.e. energy function)</p>
</div>


                            </div>
                            <div id="Target.grad_nlogp" class="classattr">
                                <div class="attr variable">
            <span class="name">grad_nlogp</span>

        
    </div>
    <a class="headerlink" href="#Target.grad_nlogp"></a>
    
            <div class="docstring"><p>function which computes nlogp and its gradient</p>
</div>


                            </div>
                            <div id="Target.transform" class="classattr">
                                        <input id="Target.transform-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Target.transform-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Target.transform"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Target.transform-33"><a href="#Target.transform-33"><span class="linenos">33</span></a>  <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="Target.transform-34"><a href="#Target.transform-34"><span class="linenos">34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; a transformation of the samples from the target distribution&quot;&quot;&quot;</span>
</span><span id="Target.transform-35"><a href="#Target.transform-35"><span class="linenos">35</span></a>    <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>a transformation of the samples from the target distribution</p>
</div>


                            </div>
                            <div id="Target.prior_draw" class="classattr">
                                        <input id="Target.prior_draw-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prior_draw</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">key</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Target.prior_draw-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Target.prior_draw"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Target.prior_draw-37"><a href="#Target.prior_draw-37"><span class="linenos">37</span></a>  <span class="k">def</span> <span class="nf">prior_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="Target.prior_draw-38"><a href="#Target.prior_draw-38"><span class="linenos">38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;**Args**: jax random key</span>
</span><span id="Target.prior_draw-39"><a href="#Target.prior_draw-39"><span class="linenos">39</span></a><span class="sd">       </span>
</span><span id="Target.prior_draw-40"><a href="#Target.prior_draw-40"><span class="linenos">40</span></a><span class="sd">       **Returns**: one random sample from the prior</span>
</span><span id="Target.prior_draw-41"><a href="#Target.prior_draw-41"><span class="linenos">41</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Target.prior_draw-42"><a href="#Target.prior_draw-42"><span class="linenos">42</span></a>
</span><span id="Target.prior_draw-43"><a href="#Target.prior_draw-43"><span class="linenos">43</span></a>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p><strong>Args</strong>: jax random key</p>

<p><strong>Returns</strong>: one random sample from the prior</p>
</div>


                            </div>
                </section>
                <section id="Sampler">
                            <input id="Sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Sampler</span>:

                <label class="view-source-button" for="Sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler-48"><a href="#Sampler-48"><span class="linenos"> 48</span></a><span class="k">class</span> <span class="nc">Sampler</span><span class="p">:</span>
</span><span id="Sampler-49"><a href="#Sampler-49"><span class="linenos"> 49</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;the MCHMC (q = 0 Hamiltonian) sampler&quot;&quot;&quot;</span>
</span><span id="Sampler-50"><a href="#Sampler-50"><span class="linenos"> 50</span></a>
</span><span id="Sampler-51"><a href="#Sampler-51"><span class="linenos"> 51</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="Sampler-52"><a href="#Sampler-52"><span class="linenos"> 52</span></a>                 <span class="n">Target</span> <span class="p">:</span> <span class="n">Target</span><span class="p">,</span>
</span><span id="Sampler-53"><a href="#Sampler-53"><span class="linenos"> 53</span></a>                 <span class="n">L</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Sampler-54"><a href="#Sampler-54"><span class="linenos"> 54</span></a>                 <span class="n">integrator</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">minimal_norm</span><span class="p">,</span> <span class="n">varEwanted</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span>
</span><span id="Sampler-55"><a href="#Sampler-55"><span class="linenos"> 55</span></a>                 <span class="n">diagonal_preconditioning</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Sampler-56"><a href="#Sampler-56"><span class="linenos"> 56</span></a>                 <span class="n">frac_tune1</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune3</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="Sampler-57"><a href="#Sampler-57"><span class="linenos"> 57</span></a>                 <span class="p">):</span>
</span><span id="Sampler-58"><a href="#Sampler-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="Sampler-59"><a href="#Sampler-59"><span class="linenos"> 59</span></a><span class="sd">                Target: the target distribution class</span>
</span><span id="Sampler-60"><a href="#Sampler-60"><span class="linenos"> 60</span></a>
</span><span id="Sampler-61"><a href="#Sampler-61"><span class="linenos"> 61</span></a><span class="sd">                **L**: momentum decoherence scale (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting frac_tune2 and 3 to zero (see below))</span>
</span><span id="Sampler-62"><a href="#Sampler-62"><span class="linenos"> 62</span></a>
</span><span id="Sampler-63"><a href="#Sampler-63"><span class="linenos"> 63</span></a><span class="sd">                **eps**: initial integration step-size (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting all frac_tune1 and 2 to zero (see below))</span>
</span><span id="Sampler-64"><a href="#Sampler-64"><span class="linenos"> 64</span></a>
</span><span id="Sampler-65"><a href="#Sampler-65"><span class="linenos"> 65</span></a><span class="sd">                **integrator**: dynamics.leapfrog or dynamics.minimal_norm. Typically minimal_norm performs better.</span>
</span><span id="Sampler-66"><a href="#Sampler-66"><span class="linenos"> 66</span></a>
</span><span id="Sampler-67"><a href="#Sampler-67"><span class="linenos"> 67</span></a><span class="sd">                **varEwanted**: if your posteriors are biased try smaller values (or larger values: perhaps the convergence is too slow). This is perhaps the parameter whose default value is the least well determined.</span>
</span><span id="Sampler-68"><a href="#Sampler-68"><span class="linenos"> 68</span></a>
</span><span id="Sampler-69"><a href="#Sampler-69"><span class="linenos"> 69</span></a><span class="sd">                **diagonal_preconditioning**: if you already have your own preconditioning or if you suspect diagonal preconditioning is not useful, turn this off as it can also make matters worse</span>
</span><span id="Sampler-70"><a href="#Sampler-70"><span class="linenos"> 70</span></a><span class="sd">                                          (but it can also be very useful if you did not precondition the parameters (make their posterior variances close to 1))</span>
</span><span id="Sampler-71"><a href="#Sampler-71"><span class="linenos"> 71</span></a>
</span><span id="Sampler-72"><a href="#Sampler-72"><span class="linenos"> 72</span></a><span class="sd">                **frac_tune1**: (num_samples * frac_tune1) steps will be used as a burn-in and to autotune the stepsize</span>
</span><span id="Sampler-73"><a href="#Sampler-73"><span class="linenos"> 73</span></a>
</span><span id="Sampler-74"><a href="#Sampler-74"><span class="linenos"> 74</span></a><span class="sd">                **frac_tune2**: (num_samples * frac_tune2) steps will be used to autotune L (should be around 10 effective samples long for the optimal performance)</span>
</span><span id="Sampler-75"><a href="#Sampler-75"><span class="linenos"> 75</span></a>
</span><span id="Sampler-76"><a href="#Sampler-76"><span class="linenos"> 76</span></a><span class="sd">                **frac_tune3**: (num_samples * frac_tune3) steps will be used to improve the L tuning (should be around 10 effective samples long for the optimal performance). This stage is not neccessary if the posterior is close to a Gaussian and does not change much in general.</span>
</span><span id="Sampler-77"><a href="#Sampler-77"><span class="linenos"> 77</span></a><span class="sd">                            It can be memory intensive in high dimensions so try turning it off if you have problems with the memory.</span>
</span><span id="Sampler-78"><a href="#Sampler-78"><span class="linenos"> 78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sampler-79"><a href="#Sampler-79"><span class="linenos"> 79</span></a>
</span><span id="Sampler-80"><a href="#Sampler-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Target</span> <span class="o">=</span> <span class="n">Target</span>
</span><span id="Sampler-81"><a href="#Sampler-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;@private&quot;&quot;&quot;</span>
</span><span id="Sampler-82"><a href="#Sampler-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-83"><a href="#Sampler-83"><span class="linenos"> 83</span></a>
</span><span id="Sampler-84"><a href="#Sampler-84"><span class="linenos"> 84</span></a>        <span class="c1">### integrator ###</span>
</span><span id="Sampler-85"><a href="#Sampler-85"><span class="linenos"> 85</span></a>        <span class="n">hamiltonian_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span> <span class="o">=</span> <span class="n">integrator</span><span class="p">(</span><span class="n">T</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">),</span> 
</span><span id="Sampler-86"><a href="#Sampler-86"><span class="linenos"> 86</span></a>                                                                <span class="n">V</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="Sampler-87"><a href="#Sampler-87"><span class="linenos"> 87</span></a>                                                                <span class="n">d</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-88"><a href="#Sampler-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span><span class="n">hamiltonian_step</span><span class="p">,</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">partially_refresh_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-89"><a href="#Sampler-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Sampler-90"><a href="#Sampler-90"><span class="linenos"> 90</span></a>
</span><span id="Sampler-91"><a href="#Sampler-91"><span class="linenos"> 91</span></a>        <span class="c1">### preconditioning ###</span>
</span><span id="Sampler-92"><a href="#Sampler-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span> <span class="o">=</span> <span class="n">diagonal_preconditioning</span>
</span><span id="Sampler-93"><a href="#Sampler-93"><span class="linenos"> 93</span></a>
</span><span id="Sampler-94"><a href="#Sampler-94"><span class="linenos"> 94</span></a>        <span class="c1">### autotuning parameters ###</span>
</span><span id="Sampler-95"><a href="#Sampler-95"><span class="linenos"> 95</span></a>
</span><span id="Sampler-96"><a href="#Sampler-96"><span class="linenos"> 96</span></a>        <span class="c1"># length of autotuning</span>
</span><span id="Sampler-97"><a href="#Sampler-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">=</span> <span class="n">frac_tune1</span> <span class="c1"># num_samples * frac_tune1 steps will be used to autotune eps</span>
</span><span id="Sampler-98"><a href="#Sampler-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">=</span> <span class="n">frac_tune2</span> <span class="c1"># num_samples * frac_tune2 steps will be used to approximately autotune L</span>
</span><span id="Sampler-99"><a href="#Sampler-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">=</span> <span class="n">frac_tune3</span> <span class="c1"># num_samples * frac_tune3 steps will be used to improve L tuning.</span>
</span><span id="Sampler-100"><a href="#Sampler-100"><span class="linenos">100</span></a>
</span><span id="Sampler-101"><a href="#Sampler-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span> <span class="o">=</span> <span class="n">varEwanted</span> <span class="c1"># 1e-3 #targeted energy variance Var[E]/d</span>
</span><span id="Sampler-102"><a href="#Sampler-102"><span class="linenos">102</span></a>        <span class="n">neff</span> <span class="o">=</span> <span class="mi">150</span> <span class="c1"># effective number of steps used to determine the stepsize in the adaptive step</span>
</span><span id="Sampler-103"><a href="#Sampler-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">neff</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># forgeting factor in the adaptive step</span>
</span><span id="Sampler-104"><a href="#Sampler-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># determines how much do we trust the stepsize predictions from the too large and too small stepsizes</span>
</span><span id="Sampler-105"><a href="#Sampler-105"><span class="linenos">105</span></a>
</span><span id="Sampler-106"><a href="#Sampler-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1">#in the third stage we set L = Lfactor * (configuration space distance bewteen independent samples)</span>
</span><span id="Sampler-107"><a href="#Sampler-107"><span class="linenos">107</span></a>
</span><span id="Sampler-108"><a href="#Sampler-108"><span class="linenos">108</span></a>
</span><span id="Sampler-109"><a href="#Sampler-109"><span class="linenos">109</span></a>        <span class="c1">### default eps and L ###</span>
</span><span id="Sampler-110"><a href="#Sampler-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler-111"><a href="#Sampler-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="Sampler-112"><a href="#Sampler-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#default value (works if the target is well preconditioned). If you are not happy with the default value and have not run the grid search we suggest using the autotuning</span>
</span><span id="Sampler-113"><a href="#Sampler-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-114"><a href="#Sampler-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="n">eps</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler-115"><a href="#Sampler-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
</span><span id="Sampler-116"><a href="#Sampler-116"><span class="linenos">116</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#defualt value (assumes preconditioned target and even then it might not work). Unless you have done a grid search to determine this value we suggest using the autotuning</span>
</span><span id="Sampler-117"><a href="#Sampler-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
</span><span id="Sampler-118"><a href="#Sampler-118"><span class="linenos">118</span></a>
</span><span id="Sampler-119"><a href="#Sampler-119"><span class="linenos">119</span></a>
</span><span id="Sampler-120"><a href="#Sampler-120"><span class="linenos">120</span></a>
</span><span id="Sampler-121"><a href="#Sampler-121"><span class="linenos">121</span></a>    <span class="k">def</span> <span class="nf">nan_reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">):</span>
</span><span id="Sampler-122"><a href="#Sampler-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if there are nans, let&#39;s reduce the stepsize, and not update the state. The function returns the old state in this case.&quot;&quot;&quot;</span>
</span><span id="Sampler-123"><a href="#Sampler-123"><span class="linenos">123</span></a>        
</span><span id="Sampler-124"><a href="#Sampler-124"><span class="linenos">124</span></a>        <span class="n">nonans</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
</span><span id="Sampler-125"><a href="#Sampler-125"><span class="linenos">125</span></a>
</span><span id="Sampler-126"><a href="#Sampler-126"><span class="linenos">126</span></a>        <span class="k">return</span> <span class="n">nonans</span><span class="p">,</span> <span class="o">*</span><span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonans</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">new</span><span class="p">),</span> <span class="n">old</span><span class="p">),</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
</span><span id="Sampler-127"><a href="#Sampler-127"><span class="linenos">127</span></a>        
</span><span id="Sampler-128"><a href="#Sampler-128"><span class="linenos">128</span></a>        
</span><span id="Sampler-129"><a href="#Sampler-129"><span class="linenos">129</span></a>        
</span><span id="Sampler-130"><a href="#Sampler-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="nf">dynamics_adaptive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler-131"><a href="#Sampler-131"><span class="linenos">131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;One step of the dynamics with the adaptive stepsize&quot;&quot;&quot;</span>
</span><span id="Sampler-132"><a href="#Sampler-132"><span class="linenos">132</span></a>
</span><span id="Sampler-133"><a href="#Sampler-133"><span class="linenos">133</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler-134"><a href="#Sampler-134"><span class="linenos">134</span></a>
</span><span id="Sampler-135"><a href="#Sampler-135"><span class="linenos">135</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Feps</span><span class="o">/</span><span class="n">Weps</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="c1">#We use the Var[E] = O(eps^6) relation here.</span>
</span><span id="Sampler-136"><a href="#Sampler-136"><span class="linenos">136</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps_max</span>  <span class="c1"># if the proposed stepsize is above the stepsize where we have seen divergences</span>
</span><span id="Sampler-137"><a href="#Sampler-137"><span class="linenos">137</span></a>
</span><span id="Sampler-138"><a href="#Sampler-138"><span class="linenos">138</span></a>        <span class="c1"># dynamics</span>
</span><span id="Sampler-139"><a href="#Sampler-139"><span class="linenos">139</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-140"><a href="#Sampler-140"><span class="linenos">140</span></a>
</span><span id="Sampler-141"><a href="#Sampler-141"><span class="linenos">141</span></a>        <span class="c1"># step updating</span>
</span><span id="Sampler-142"><a href="#Sampler-142"><span class="linenos">142</span></a>        <span class="n">success</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_reject</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">)</span>
</span><span id="Sampler-143"><a href="#Sampler-143"><span class="linenos">143</span></a>
</span><span id="Sampler-144"><a href="#Sampler-144"><span class="linenos">144</span></a>        <span class="n">DE</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>  <span class="c1"># energy difference</span>
</span><span id="Sampler-145"><a href="#Sampler-145"><span class="linenos">145</span></a>        <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">DE</span>  <span class="c1"># energy</span>
</span><span id="Sampler-146"><a href="#Sampler-146"><span class="linenos">146</span></a>        <span class="c1"># Warning: var = 0 if there were nans, but we will give it a very small weight</span>
</span><span id="Sampler-147"><a href="#Sampler-147"><span class="linenos">147</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">((</span><span class="n">DE</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-8</span>  <span class="c1"># 1e-8 is added to avoid divergences in log xi</span>
</span><span id="Sampler-148"><a href="#Sampler-148"><span class="linenos">148</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="p">)))</span>  <span class="c1"># the weight which reduces the impact of stepsizes which are much larger on much smaller than the desired one.</span>
</span><span id="Sampler-149"><a href="#Sampler-149"><span class="linenos">149</span></a>        <span class="n">Feps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Feps</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>  <span class="c1"># Kalman update the linear combinations</span>
</span><span id="Sampler-150"><a href="#Sampler-150"><span class="linenos">150</span></a>        <span class="n">Weps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Weps</span> <span class="o">+</span> <span class="n">w</span>
</span><span id="Sampler-151"><a href="#Sampler-151"><span class="linenos">151</span></a>
</span><span id="Sampler-152"><a href="#Sampler-152"><span class="linenos">152</span></a>        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">success</span>
</span><span id="Sampler-153"><a href="#Sampler-153"><span class="linenos">153</span></a>
</span><span id="Sampler-154"><a href="#Sampler-154"><span class="linenos">154</span></a>
</span><span id="Sampler-155"><a href="#Sampler-155"><span class="linenos">155</span></a>
</span><span id="Sampler-156"><a href="#Sampler-156"><span class="linenos">156</span></a>    <span class="c1">### sampling routine ###</span>
</span><span id="Sampler-157"><a href="#Sampler-157"><span class="linenos">157</span></a>
</span><span id="Sampler-158"><a href="#Sampler-158"><span class="linenos">158</span></a>    <span class="k">def</span> <span class="nf">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">):</span>
</span><span id="Sampler-159"><a href="#Sampler-159"><span class="linenos">159</span></a>
</span><span id="Sampler-160"><a href="#Sampler-160"><span class="linenos">160</span></a>        <span class="c1">### random key ###</span>
</span><span id="Sampler-161"><a href="#Sampler-161"><span class="linenos">161</span></a>        <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler-162"><a href="#Sampler-162"><span class="linenos">162</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler-163"><a href="#Sampler-163"><span class="linenos">163</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-164"><a href="#Sampler-164"><span class="linenos">164</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="Sampler-165"><a href="#Sampler-165"><span class="linenos">165</span></a>
</span><span id="Sampler-166"><a href="#Sampler-166"><span class="linenos">166</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="Sampler-167"><a href="#Sampler-167"><span class="linenos">167</span></a>        <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="Sampler-168"><a href="#Sampler-168"><span class="linenos">168</span></a>            <span class="n">key</span><span class="p">,</span> <span class="n">prior_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="Sampler-169"><a href="#Sampler-169"><span class="linenos">169</span></a>            <span class="n">x_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">prior_key</span><span class="p">)</span>
</span><span id="Sampler-170"><a href="#Sampler-170"><span class="linenos">170</span></a>        
</span><span id="Sampler-171"><a href="#Sampler-171"><span class="linenos">171</span></a>        <span class="n">l</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="Sampler-172"><a href="#Sampler-172"><span class="linenos">172</span></a>
</span><span id="Sampler-173"><a href="#Sampler-173"><span class="linenos">173</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="Sampler-174"><a href="#Sampler-174"><span class="linenos">174</span></a>        <span class="c1">#u = - g / jnp.sqrt(jnp.sum(jnp.square(g))) #initialize momentum in the direction of the gradient of log p</span>
</span><span id="Sampler-175"><a href="#Sampler-175"><span class="linenos">175</span></a>
</span><span id="Sampler-176"><a href="#Sampler-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span>
</span><span id="Sampler-177"><a href="#Sampler-177"><span class="linenos">177</span></a>
</span><span id="Sampler-178"><a href="#Sampler-178"><span class="linenos">178</span></a>
</span><span id="Sampler-179"><a href="#Sampler-179"><span class="linenos">179</span></a>
</span><span id="Sampler-180"><a href="#Sampler-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_initial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">random_key</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">thinning</span><span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Sampler-181"><a href="#Sampler-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="Sampler-182"><a href="#Sampler-182"><span class="linenos">182</span></a><span class="sd">               num_steps: number of integration steps to take.</span>
</span><span id="Sampler-183"><a href="#Sampler-183"><span class="linenos">183</span></a>
</span><span id="Sampler-184"><a href="#Sampler-184"><span class="linenos">184</span></a><span class="sd">               num_chains: number of independent chains, defaults to 1. If different than 1, jax will parallelize the computation with the number of available devices (CPU, GPU, TPU),</span>
</span><span id="Sampler-185"><a href="#Sampler-185"><span class="linenos">185</span></a><span class="sd">               as returned by jax.local_device_count().</span>
</span><span id="Sampler-186"><a href="#Sampler-186"><span class="linenos">186</span></a>
</span><span id="Sampler-187"><a href="#Sampler-187"><span class="linenos">187</span></a><span class="sd">               x_initial: initial condition for x, shape: (d, ). Defaults to None in which case the initial condition is drawn from the prior distribution (self.Target.prior_draw).</span>
</span><span id="Sampler-188"><a href="#Sampler-188"><span class="linenos">188</span></a>
</span><span id="Sampler-189"><a href="#Sampler-189"><span class="linenos">189</span></a><span class="sd">               random_key: jax random seed, defaults to jax.random.PRNGKey(0)</span>
</span><span id="Sampler-190"><a href="#Sampler-190"><span class="linenos">190</span></a>
</span><span id="Sampler-191"><a href="#Sampler-191"><span class="linenos">191</span></a><span class="sd">               output: determines the output of the function:</span>
</span><span id="Sampler-192"><a href="#Sampler-192"><span class="linenos">192</span></a>
</span><span id="Sampler-193"><a href="#Sampler-193"><span class="linenos">193</span></a><span class="sd">                        &#39;normal&#39;: samples, burn in steps.</span>
</span><span id="Sampler-194"><a href="#Sampler-194"><span class="linenos">194</span></a><span class="sd">                            samples were transformed by the Target.transform to save memory and have shape: (num_samples, len(Target.transform(x)))</span>
</span><span id="Sampler-195"><a href="#Sampler-195"><span class="linenos">195</span></a>
</span><span id="Sampler-196"><a href="#Sampler-196"><span class="linenos">196</span></a><span class="sd">                        &#39;expectation&#39;: exepcted value of transform(x)</span>
</span><span id="Sampler-197"><a href="#Sampler-197"><span class="linenos">197</span></a><span class="sd">                            most memory efficient. If you are after memory it might be usefull to turn off the third tuning stage</span>
</span><span id="Sampler-198"><a href="#Sampler-198"><span class="linenos">198</span></a>
</span><span id="Sampler-199"><a href="#Sampler-199"><span class="linenos">199</span></a><span class="sd">                        &#39;detailed&#39;: samples, energy error for each step, L and eps used for sampling</span>
</span><span id="Sampler-200"><a href="#Sampler-200"><span class="linenos">200</span></a>
</span><span id="Sampler-201"><a href="#Sampler-201"><span class="linenos">201</span></a><span class="sd">                        &#39;ess&#39;: Effective Sample Size per gradient evaluation, float.</span>
</span><span id="Sampler-202"><a href="#Sampler-202"><span class="linenos">202</span></a><span class="sd">                            In this case, self.Target.variance = &lt;x_i^2&gt;_true should be defined.</span>
</span><span id="Sampler-203"><a href="#Sampler-203"><span class="linenos">203</span></a>
</span><span id="Sampler-204"><a href="#Sampler-204"><span class="linenos">204</span></a><span class="sd">                thinning: only one every &#39;thinning&#39; steps is stored. Defaults to 1.</span>
</span><span id="Sampler-205"><a href="#Sampler-205"><span class="linenos">205</span></a><span class="sd">                        This is not the recommended solution to save memory. It is better to use the transform functionality.</span>
</span><span id="Sampler-206"><a href="#Sampler-206"><span class="linenos">206</span></a><span class="sd">                        If this is not sufficient consider saving only the expected values, by setting output= &#39;expectation&#39;.</span>
</span><span id="Sampler-207"><a href="#Sampler-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sampler-208"><a href="#Sampler-208"><span class="linenos">208</span></a>        
</span><span id="Sampler-209"><a href="#Sampler-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler-210"><a href="#Sampler-210"><span class="linenos">210</span></a>            <span class="k">for</span> <span class="n">ground_truth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;second_moments&#39;</span><span class="p">,</span> <span class="s1">&#39;variance_second_moments&#39;</span><span class="p">]:</span>
</span><span id="Sampler-211"><a href="#Sampler-211"><span class="linenos">211</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
</span><span id="Sampler-212"><a href="#Sampler-212"><span class="linenos">212</span></a>                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.&quot;</span> <span class="o">+</span> <span class="n">ground_truth</span> <span class="o">+</span> <span class="s2">&quot; should be defined if you want to use output = ess.&quot;</span><span class="p">)</span>
</span><span id="Sampler-213"><a href="#Sampler-213"><span class="linenos">213</span></a>        
</span><span id="Sampler-214"><a href="#Sampler-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">num_chains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler-215"><a href="#Sampler-215"><span class="linenos">215</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span> <span class="c1">#the function which actually does the sampling</span>
</span><span id="Sampler-216"><a href="#Sampler-216"><span class="linenos">216</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler-217"><a href="#Sampler-217"><span class="linenos">217</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="Sampler-218"><a href="#Sampler-218"><span class="linenos">218</span></a>
</span><span id="Sampler-219"><a href="#Sampler-219"><span class="linenos">219</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-220"><a href="#Sampler-220"><span class="linenos">220</span></a>                <span class="k">return</span> <span class="n">results</span>
</span><span id="Sampler-221"><a href="#Sampler-221"><span class="linenos">221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-222"><a href="#Sampler-222"><span class="linenos">222</span></a>            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">local_device_count</span><span class="p">()</span>
</span><span id="Sampler-223"><a href="#Sampler-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler-224"><a href="#Sampler-224"><span class="linenos">224</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler-225"><a href="#Sampler-225"><span class="linenos">225</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-226"><a href="#Sampler-226"><span class="linenos">226</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="Sampler-227"><a href="#Sampler-227"><span class="linenos">227</span></a>
</span><span id="Sampler-228"><a href="#Sampler-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="Sampler-229"><a href="#Sampler-229"><span class="linenos">229</span></a>                <span class="n">keys_all</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Sampler-230"><a href="#Sampler-230"><span class="linenos">230</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">keys_all</span><span class="p">[</span><span class="n">num_chains</span><span class="o">+</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)])</span>
</span><span id="Sampler-231"><a href="#Sampler-231"><span class="linenos">231</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">keys_all</span><span class="p">[:</span><span class="n">num_chains</span><span class="p">]</span>
</span><span id="Sampler-232"><a href="#Sampler-232"><span class="linenos">232</span></a>
</span><span id="Sampler-233"><a href="#Sampler-233"><span class="linenos">233</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#initial x is given</span>
</span><span id="Sampler-234"><a href="#Sampler-234"><span class="linenos">234</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="Sampler-235"><a href="#Sampler-235"><span class="linenos">235</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span><span class="p">)</span>
</span><span id="Sampler-236"><a href="#Sampler-236"><span class="linenos">236</span></a>
</span><span id="Sampler-237"><a href="#Sampler-237"><span class="linenos">237</span></a>
</span><span id="Sampler-238"><a href="#Sampler-238"><span class="linenos">238</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="Sampler-239"><a href="#Sampler-239"><span class="linenos">239</span></a>
</span><span id="Sampler-240"><a href="#Sampler-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">num_cores</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#run the chains on parallel cores</span>
</span><span id="Sampler-241"><a href="#Sampler-241"><span class="linenos">241</span></a>                <span class="n">parallel_function</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span><span id="Sampler-242"><a href="#Sampler-242"><span class="linenos">242</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">parallel_function</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_cores</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">//</span> <span class="n">num_cores</span><span class="p">))</span>
</span><span id="Sampler-243"><a href="#Sampler-243"><span class="linenos">243</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler-244"><a href="#Sampler-244"><span class="linenos">244</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_chains</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">))</span>
</span><span id="Sampler-245"><a href="#Sampler-245"><span class="linenos">245</span></a>
</span><span id="Sampler-246"><a href="#Sampler-246"><span class="linenos">246</span></a>                <span class="c1">### reshape results ###</span>
</span><span id="Sampler-247"><a href="#Sampler-247"><span class="linenos">247</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span> <span class="c1">#each chain returned a tuple</span>
</span><span id="Sampler-248"><a href="#Sampler-248"><span class="linenos">248</span></a>                    <span class="n">results_reshaped</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="Sampler-249"><a href="#Sampler-249"><span class="linenos">249</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="Sampler-250"><a href="#Sampler-250"><span class="linenos">250</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Sampler-251"><a href="#Sampler-251"><span class="linenos">251</span></a>                        <span class="n">results_reshaped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">))]))</span>
</span><span id="Sampler-252"><a href="#Sampler-252"><span class="linenos">252</span></a>                    <span class="k">return</span> <span class="n">results_reshaped</span>
</span><span id="Sampler-253"><a href="#Sampler-253"><span class="linenos">253</span></a>
</span><span id="Sampler-254"><a href="#Sampler-254"><span class="linenos">254</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-255"><a href="#Sampler-255"><span class="linenos">255</span></a>                    <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">))])</span>
</span><span id="Sampler-256"><a href="#Sampler-256"><span class="linenos">256</span></a>
</span><span id="Sampler-257"><a href="#Sampler-257"><span class="linenos">257</span></a>
</span><span id="Sampler-258"><a href="#Sampler-258"><span class="linenos">258</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#run chains serially on a single core</span>
</span><span id="Sampler-259"><a href="#Sampler-259"><span class="linenos">259</span></a>
</span><span id="Sampler-260"><a href="#Sampler-260"><span class="linenos">260</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">))</span>
</span><span id="Sampler-261"><a href="#Sampler-261"><span class="linenos">261</span></a>
</span><span id="Sampler-262"><a href="#Sampler-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler-263"><a href="#Sampler-263"><span class="linenos">263</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="Sampler-264"><a href="#Sampler-264"><span class="linenos">264</span></a>
</span><span id="Sampler-265"><a href="#Sampler-265"><span class="linenos">265</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="Sampler-266"><a href="#Sampler-266"><span class="linenos">266</span></a>                    <span class="k">return</span> <span class="n">results</span>
</span><span id="Sampler-267"><a href="#Sampler-267"><span class="linenos">267</span></a>
</span><span id="Sampler-268"><a href="#Sampler-268"><span class="linenos">268</span></a>
</span><span id="Sampler-269"><a href="#Sampler-269"><span class="linenos">269</span></a>
</span><span id="Sampler-270"><a href="#Sampler-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="nf">single_chain_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler-271"><a href="#Sampler-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;sampling routine. It is called by self.sample&quot;&quot;&quot;</span>
</span><span id="Sampler-272"><a href="#Sampler-272"><span class="linenos">272</span></a>        
</span><span id="Sampler-273"><a href="#Sampler-273"><span class="linenos">273</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="Sampler-274"><a href="#Sampler-274"><span class="linenos">274</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_conditions</span><span class="p">(</span><span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="Sampler-275"><a href="#Sampler-275"><span class="linenos">275</span></a>        <span class="n">L</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="c1">#the initial values, given at the class initialization (or set to the default values)</span>
</span><span id="Sampler-276"><a href="#Sampler-276"><span class="linenos">276</span></a>
</span><span id="Sampler-277"><a href="#Sampler-277"><span class="linenos">277</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="c1"># jnp.ones(self.Target.d)  # no diagonal preconditioning</span>
</span><span id="Sampler-278"><a href="#Sampler-278"><span class="linenos">278</span></a>
</span><span id="Sampler-279"><a href="#Sampler-279"><span class="linenos">279</span></a>        <span class="c1">### auto-tune the hyperparameters L and eps ###</span>
</span><span id="Sampler-280"><a href="#Sampler-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="Sampler-281"><a href="#Sampler-281"><span class="linenos">281</span></a>            <span class="n">steps1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span><span class="p">)</span>
</span><span id="Sampler-282"><a href="#Sampler-282"><span class="linenos">282</span></a>            <span class="n">steps2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span><span class="p">)</span>
</span><span id="Sampler-283"><a href="#Sampler-283"><span class="linenos">283</span></a>            <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps1</span><span class="p">,</span> <span class="n">steps2</span><span class="p">)</span> <span class="c1">#the cheap tuning (100 steps)</span>
</span><span id="Sampler-284"><a href="#Sampler-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if we want to further improve L tuning we go to the second stage (which is a bit slower)</span>
</span><span id="Sampler-285"><a href="#Sampler-285"><span class="linenos">285</span></a>                <span class="n">steps3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span><span class="p">)</span>
</span><span id="Sampler-286"><a href="#Sampler-286"><span class="linenos">286</span></a>                <span class="n">L</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps3</span><span class="p">)</span>
</span><span id="Sampler-287"><a href="#Sampler-287"><span class="linenos">287</span></a>
</span><span id="Sampler-288"><a href="#Sampler-288"><span class="linenos">288</span></a>        <span class="c1">### sampling ###</span>
</span><span id="Sampler-289"><a href="#Sampler-289"><span class="linenos">289</span></a>
</span><span id="Sampler-290"><a href="#Sampler-290"><span class="linenos">290</span></a>        
</span><span id="Sampler-291"><a href="#Sampler-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span> <span class="ow">or</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="Sampler-292"><a href="#Sampler-292"><span class="linenos">292</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_normal</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="Sampler-293"><a href="#Sampler-293"><span class="linenos">293</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="Sampler-294"><a href="#Sampler-294"><span class="linenos">294</span></a>                <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span>
</span><span id="Sampler-295"><a href="#Sampler-295"><span class="linenos">295</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-296"><a href="#Sampler-296"><span class="linenos">296</span></a>                <span class="k">return</span> <span class="n">X</span>
</span><span id="Sampler-297"><a href="#Sampler-297"><span class="linenos">297</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">expectation</span><span class="p">:</span>
</span><span id="Sampler-298"><a href="#Sampler-298"><span class="linenos">298</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_expectation</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-299"><a href="#Sampler-299"><span class="linenos">299</span></a>
</span><span id="Sampler-300"><a href="#Sampler-300"><span class="linenos">300</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler-301"><a href="#Sampler-301"><span class="linenos">301</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Sampler-302"><a href="#Sampler-302"><span class="linenos">302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance</span>
</span><span id="Sampler-303"><a href="#Sampler-303"><span class="linenos">303</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="Sampler-304"><a href="#Sampler-304"><span class="linenos">304</span></a>                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.variance should be defined&quot;</span><span class="p">)</span>
</span><span id="Sampler-305"><a href="#Sampler-305"><span class="linenos">305</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ess</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-306"><a href="#Sampler-306"><span class="linenos">306</span></a>
</span><span id="Sampler-307"><a href="#Sampler-307"><span class="linenos">307</span></a>       
</span><span id="Sampler-308"><a href="#Sampler-308"><span class="linenos">308</span></a>    <span class="c1">### for loops which do the sampling steps: ###</span>
</span><span id="Sampler-309"><a href="#Sampler-309"><span class="linenos">309</span></a>
</span><span id="Sampler-310"><a href="#Sampler-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">sample_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler-311"><a href="#Sampler-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler-312"><a href="#Sampler-312"><span class="linenos">312</span></a>        
</span><span id="Sampler-313"><a href="#Sampler-313"><span class="linenos">313</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-314"><a href="#Sampler-314"><span class="linenos">314</span></a>
</span><span id="Sampler-315"><a href="#Sampler-315"><span class="linenos">315</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler-316"><a href="#Sampler-316"><span class="linenos">316</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-317"><a href="#Sampler-317"><span class="linenos">317</span></a>
</span><span id="Sampler-318"><a href="#Sampler-318"><span class="linenos">318</span></a>            <span class="c1"># left in as a comment since it may be useful when experimenting with neighbour lists in MD</span>
</span><span id="Sampler-319"><a href="#Sampler-319"><span class="linenos">319</span></a>            <span class="c1"># if self.Target.nbrs:</span>
</span><span id="Sampler-320"><a href="#Sampler-320"><span class="linenos">320</span></a>            <span class="c1">#     self.Target.nbrs = self.Target.nbrs.update(jnp.reshape(xx, (-1,3)), neighbor=self.Target.nbrs)</span>
</span><span id="Sampler-321"><a href="#Sampler-321"><span class="linenos">321</span></a>            
</span><span id="Sampler-322"><a href="#Sampler-322"><span class="linenos">322</span></a>            <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler-323"><a href="#Sampler-323"><span class="linenos">323</span></a>            
</span><span id="Sampler-324"><a href="#Sampler-324"><span class="linenos">324</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">ll</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>
</span><span id="Sampler-325"><a href="#Sampler-325"><span class="linenos">325</span></a>
</span><span id="Sampler-326"><a href="#Sampler-326"><span class="linenos">326</span></a>
</span><span id="Sampler-327"><a href="#Sampler-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="n">thinning</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler-328"><a href="#Sampler-328"><span class="linenos">328</span></a>            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler-329"><a href="#Sampler-329"><span class="linenos">329</span></a>
</span><span id="Sampler-330"><a href="#Sampler-330"><span class="linenos">330</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-331"><a href="#Sampler-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_thinning</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="Sampler-332"><a href="#Sampler-332"><span class="linenos">332</span></a>
</span><span id="Sampler-333"><a href="#Sampler-333"><span class="linenos">333</span></a>
</span><span id="Sampler-334"><a href="#Sampler-334"><span class="linenos">334</span></a>    <span class="k">def</span> <span class="nf">sample_thinning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler-335"><a href="#Sampler-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler-336"><a href="#Sampler-336"><span class="linenos">336</span></a>
</span><span id="Sampler-337"><a href="#Sampler-337"><span class="linenos">337</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-338"><a href="#Sampler-338"><span class="linenos">338</span></a>
</span><span id="Sampler-339"><a href="#Sampler-339"><span class="linenos">339</span></a>            <span class="k">def</span> <span class="nf">substep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-340"><a href="#Sampler-340"><span class="linenos">340</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler-341"><a href="#Sampler-341"><span class="linenos">341</span></a>                <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-342"><a href="#Sampler-342"><span class="linenos">342</span></a>                <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler-343"><a href="#Sampler-343"><span class="linenos">343</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="Sampler-344"><a href="#Sampler-344"><span class="linenos">344</span></a>
</span><span id="Sampler-345"><a href="#Sampler-345"><span class="linenos">345</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">substep</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#do &#39;thinning&#39; steps without saving</span>
</span><span id="Sampler-346"><a href="#Sampler-346"><span class="linenos">346</span></a>
</span><span id="Sampler-347"><a href="#Sampler-347"><span class="linenos">347</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#save one sample</span>
</span><span id="Sampler-348"><a href="#Sampler-348"><span class="linenos">348</span></a>
</span><span id="Sampler-349"><a href="#Sampler-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps</span> <span class="o">//</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler-350"><a href="#Sampler-350"><span class="linenos">350</span></a>
</span><span id="Sampler-351"><a href="#Sampler-351"><span class="linenos">351</span></a>
</span><span id="Sampler-352"><a href="#Sampler-352"><span class="linenos">352</span></a>
</span><span id="Sampler-353"><a href="#Sampler-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">sample_expectation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler-354"><a href="#Sampler-354"><span class="linenos">354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores no history but keeps the expected value of transform(x).&quot;&quot;&quot;</span>
</span><span id="Sampler-355"><a href="#Sampler-355"><span class="linenos">355</span></a>        
</span><span id="Sampler-356"><a href="#Sampler-356"><span class="linenos">356</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-357"><a href="#Sampler-357"><span class="linenos">357</span></a>            
</span><span id="Sampler-358"><a href="#Sampler-358"><span class="linenos">358</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-359"><a href="#Sampler-359"><span class="linenos">359</span></a>            
</span><span id="Sampler-360"><a href="#Sampler-360"><span class="linenos">360</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="kc">None</span>
</span><span id="Sampler-361"><a href="#Sampler-361"><span class="linenos">361</span></a>
</span><span id="Sampler-362"><a href="#Sampler-362"><span class="linenos">362</span></a>        <span class="n">state1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="Sampler-363"><a href="#Sampler-363"><span class="linenos">363</span></a>        <span class="n">state2</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Sampler-364"><a href="#Sampler-364"><span class="linenos">364</span></a>        <span class="k">return</span>  <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="p">(</span><span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_steps</span>
</span><span id="Sampler-365"><a href="#Sampler-365"><span class="linenos">365</span></a>        
</span><span id="Sampler-366"><a href="#Sampler-366"><span class="linenos">366</span></a>
</span><span id="Sampler-367"><a href="#Sampler-367"><span class="linenos">367</span></a>
</span><span id="Sampler-368"><a href="#Sampler-368"><span class="linenos">368</span></a>
</span><span id="Sampler-369"><a href="#Sampler-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">sample_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler-370"><a href="#Sampler-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores the bias of the second moments for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler-371"><a href="#Sampler-371"><span class="linenos">371</span></a>        
</span><span id="Sampler-372"><a href="#Sampler-372"><span class="linenos">372</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state_track</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-373"><a href="#Sampler-373"><span class="linenos">373</span></a>            
</span><span id="Sampler-374"><a href="#Sampler-374"><span class="linenos">374</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Sampler-375"><a href="#Sampler-375"><span class="linenos">375</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-376"><a href="#Sampler-376"><span class="linenos">376</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler-377"><a href="#Sampler-377"><span class="linenos">377</span></a>        
</span><span id="Sampler-378"><a href="#Sampler-378"><span class="linenos">378</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler-379"><a href="#Sampler-379"><span class="linenos">379</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Sampler-380"><a href="#Sampler-380"><span class="linenos">380</span></a>            <span class="n">bias_d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">second_moments</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance_second_moments</span>
</span><span id="Sampler-381"><a href="#Sampler-381"><span class="linenos">381</span></a>            <span class="n">bias</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bias_d</span><span class="p">)</span>
</span><span id="Sampler-382"><a href="#Sampler-382"><span class="linenos">382</span></a>            <span class="c1">#bias = jnp.max(bias_d)</span>
</span><span id="Sampler-383"><a href="#Sampler-383"><span class="linenos">383</span></a>
</span><span id="Sampler-384"><a href="#Sampler-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">bias</span>
</span><span id="Sampler-385"><a href="#Sampler-385"><span class="linenos">385</span></a>
</span><span id="Sampler-386"><a href="#Sampler-386"><span class="linenos">386</span></a>        
</span><span id="Sampler-387"><a href="#Sampler-387"><span class="linenos">387</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="Sampler-388"><a href="#Sampler-388"><span class="linenos">388</span></a>
</span><span id="Sampler-389"><a href="#Sampler-389"><span class="linenos">389</span></a>        <span class="c1">#nans = jnp.any(jnp.isnan(b))</span>
</span><span id="Sampler-390"><a href="#Sampler-390"><span class="linenos">390</span></a>
</span><span id="Sampler-391"><a href="#Sampler-391"><span class="linenos">391</span></a>        <span class="k">return</span> <span class="n">b</span> <span class="c1">#+ nans * 1e5 #return a large bias if there were nans</span>
</span><span id="Sampler-392"><a href="#Sampler-392"><span class="linenos">392</span></a>
</span><span id="Sampler-393"><a href="#Sampler-393"><span class="linenos">393</span></a>
</span><span id="Sampler-394"><a href="#Sampler-394"><span class="linenos">394</span></a>    <span class="c1">### tuning phase: ###</span>
</span><span id="Sampler-395"><a href="#Sampler-395"><span class="linenos">395</span></a>
</span><span id="Sampler-396"><a href="#Sampler-396"><span class="linenos">396</span></a>    <span class="k">def</span> <span class="nf">tune12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L_given</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma_given</span><span class="p">,</span> <span class="n">num_steps1</span><span class="p">,</span> <span class="n">num_steps2</span><span class="p">):</span>
</span><span id="Sampler-397"><a href="#Sampler-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;cheap hyperparameter tuning&quot;&quot;&quot;</span>
</span><span id="Sampler-398"><a href="#Sampler-398"><span class="linenos">398</span></a>        
</span><span id="Sampler-399"><a href="#Sampler-399"><span class="linenos">399</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_given</span>
</span><span id="Sampler-400"><a href="#Sampler-400"><span class="linenos">400</span></a>
</span><span id="Sampler-401"><a href="#Sampler-401"><span class="linenos">401</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">outer_weight</span><span class="p">):</span>
</span><span id="Sampler-402"><a href="#Sampler-402"><span class="linenos">402</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;one adaptive step of the dynamics&quot;&quot;&quot;</span>
</span><span id="Sampler-403"><a href="#Sampler-403"><span class="linenos">403</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_adaptive</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-404"><a href="#Sampler-404"><span class="linenos">404</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler-405"><a href="#Sampler-405"><span class="linenos">405</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">outer_weight</span> <span class="o">*</span> <span class="n">eps</span>
</span><span id="Sampler-406"><a href="#Sampler-406"><span class="linenos">406</span></a>            <span class="n">zero_prevention</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">outer_weight</span>
</span><span id="Sampler-407"><a href="#Sampler-407"><span class="linenos">407</span></a>            <span class="n">F1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler-408"><a href="#Sampler-408"><span class="linenos">408</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F2</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler-409"><a href="#Sampler-409"><span class="linenos">409</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="n">w</span>
</span><span id="Sampler-410"><a href="#Sampler-410"><span class="linenos">410</span></a>
</span><span id="Sampler-411"><a href="#Sampler-411"><span class="linenos">411</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">eps</span>
</span><span id="Sampler-412"><a href="#Sampler-412"><span class="linenos">412</span></a>
</span><span id="Sampler-413"><a href="#Sampler-413"><span class="linenos">413</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">L_given</span>
</span><span id="Sampler-414"><a href="#Sampler-414"><span class="linenos">414</span></a>
</span><span id="Sampler-415"><a href="#Sampler-415"><span class="linenos">415</span></a>        <span class="c1"># we use the last num_steps2 to compute the diagonal preconditioner</span>
</span><span id="Sampler-416"><a href="#Sampler-416"><span class="linenos">416</span></a>        <span class="n">outer_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_steps2</span><span class="p">)))</span>
</span><span id="Sampler-417"><a href="#Sampler-417"><span class="linenos">417</span></a>
</span><span id="Sampler-418"><a href="#Sampler-418"><span class="linenos">418</span></a>        <span class="c1">#initial state</span>
</span><span id="Sampler-419"><a href="#Sampler-419"><span class="linenos">419</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</span><span id="Sampler-420"><a href="#Sampler-420"><span class="linenos">420</span></a>        <span class="c1"># run the steps</span>
</span><span id="Sampler-421"><a href="#Sampler-421"><span class="linenos">421</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">outer_weights</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps1</span> <span class="o">+</span> <span class="n">num_steps2</span><span class="p">)</span>
</span><span id="Sampler-422"><a href="#Sampler-422"><span class="linenos">422</span></a>        <span class="c1"># determine L</span>
</span><span id="Sampler-423"><a href="#Sampler-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">num_steps2</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="Sampler-424"><a href="#Sampler-424"><span class="linenos">424</span></a>            <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Sampler-425"><a href="#Sampler-425"><span class="linenos">425</span></a>            <span class="n">variances</span> <span class="o">=</span> <span class="n">F2</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F1</span><span class="p">)</span>
</span><span id="Sampler-426"><a href="#Sampler-426"><span class="linenos">426</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="Sampler-427"><a href="#Sampler-427"><span class="linenos">427</span></a>
</span><span id="Sampler-428"><a href="#Sampler-428"><span class="linenos">428</span></a>            <span class="c1"># optionally we do the diagonal preconditioning (and readjust the stepsize)</span>
</span><span id="Sampler-429"><a href="#Sampler-429"><span class="linenos">429</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span><span class="p">:</span>
</span><span id="Sampler-430"><a href="#Sampler-430"><span class="linenos">430</span></a>
</span><span id="Sampler-431"><a href="#Sampler-431"><span class="linenos">431</span></a>                <span class="c1"># diagonal preconditioning</span>
</span><span id="Sampler-432"><a href="#Sampler-432"><span class="linenos">432</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="Sampler-433"><a href="#Sampler-433"><span class="linenos">433</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-434"><a href="#Sampler-434"><span class="linenos">434</span></a>
</span><span id="Sampler-435"><a href="#Sampler-435"><span class="linenos">435</span></a>                <span class="c1">#readjust the stepsize</span>
</span><span id="Sampler-436"><a href="#Sampler-436"><span class="linenos">436</span></a>                <span class="n">steps</span> <span class="o">=</span> <span class="n">num_steps2</span> <span class="o">//</span> <span class="mi">3</span> <span class="c1">#we do some small number of steps</span>
</span><span id="Sampler-437"><a href="#Sampler-437"><span class="linenos">437</span></a>                <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="Sampler-438"><a href="#Sampler-438"><span class="linenos">438</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-439"><a href="#Sampler-439"><span class="linenos">439</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler-440"><a href="#Sampler-440"><span class="linenos">440</span></a>
</span><span id="Sampler-441"><a href="#Sampler-441"><span class="linenos">441</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># the final state</span>
</span><span id="Sampler-442"><a href="#Sampler-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="c1">#return the tuned hyperparameters and the final state</span>
</span><span id="Sampler-443"><a href="#Sampler-443"><span class="linenos">443</span></a>
</span><span id="Sampler-444"><a href="#Sampler-444"><span class="linenos">444</span></a>
</span><span id="Sampler-445"><a href="#Sampler-445"><span class="linenos">445</span></a>
</span><span id="Sampler-446"><a href="#Sampler-446"><span class="linenos">446</span></a>    <span class="k">def</span> <span class="nf">tune3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
</span><span id="Sampler-447"><a href="#Sampler-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;determine L by the autocorrelations (around 10 effective samples are needed for this to be accurate)&quot;&quot;&quot;</span>
</span><span id="Sampler-448"><a href="#Sampler-448"><span class="linenos">448</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_full</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-449"><a href="#Sampler-449"><span class="linenos">449</span></a>        <span class="n">ESS</span> <span class="o">=</span> <span class="n">ess_corr</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="Sampler-450"><a href="#Sampler-450"><span class="linenos">450</span></a>        <span class="n">Lnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">/</span> <span class="n">ESS</span> <span class="c1"># = 0.4 * correlation length</span>
</span><span id="Sampler-451"><a href="#Sampler-451"><span class="linenos">451</span></a>
</span><span id="Sampler-452"><a href="#Sampler-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="n">Lnew</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span><span id="Sampler-453"><a href="#Sampler-453"><span class="linenos">453</span></a>
</span><span id="Sampler-454"><a href="#Sampler-454"><span class="linenos">454</span></a>
</span><span id="Sampler-455"><a href="#Sampler-455"><span class="linenos">455</span></a>    <span class="k">def</span> <span class="nf">sample_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler-456"><a href="#Sampler-456"><span class="linenos">456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores full x for each step. Used in tune2.&quot;&quot;&quot;</span>
</span><span id="Sampler-457"><a href="#Sampler-457"><span class="linenos">457</span></a>
</span><span id="Sampler-458"><a href="#Sampler-458"><span class="linenos">458</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler-459"><a href="#Sampler-459"><span class="linenos">459</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler-460"><a href="#Sampler-460"><span class="linenos">460</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler-461"><a href="#Sampler-461"><span class="linenos">461</span></a>            <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler-462"><a href="#Sampler-462"><span class="linenos">462</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">xx</span>
</span><span id="Sampler-463"><a href="#Sampler-463"><span class="linenos">463</span></a>
</span><span id="Sampler-464"><a href="#Sampler-464"><span class="linenos">464</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">track</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="Sampler-465"><a href="#Sampler-465"><span class="linenos">465</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="Sampler-466"><a href="#Sampler-466"><span class="linenos">466</span></a>        <span class="k">return</span> <span class="n">track</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span><span id="Sampler-467"><a href="#Sampler-467"><span class="linenos">467</span></a>
</span><span id="Sampler-468"><a href="#Sampler-468"><span class="linenos">468</span></a>
</span><span id="Sampler-469"><a href="#Sampler-469"><span class="linenos">469</span></a>
</span><span id="Sampler-470"><a href="#Sampler-470"><span class="linenos">470</span></a>    <span class="k">def</span> <span class="nf">bias_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
</span><span id="Sampler-471"><a href="#Sampler-471"><span class="linenos">471</span></a>        <span class="c1">#bsq = jnp.average(results.reshape(results.shape[0] * results.shape[1], results.shape[2]), axis = 0)</span>
</span><span id="Sampler-472"><a href="#Sampler-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler-473"><a href="#Sampler-473"><span class="linenos">473</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler-474"><a href="#Sampler-474"><span class="linenos">474</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler-475"><a href="#Sampler-475"><span class="linenos">475</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">results</span>    
</span><span id="Sampler-476"><a href="#Sampler-476"><span class="linenos">476</span></a>        <span class="c1"># plt.plot(bsq)</span>
</span><span id="Sampler-477"><a href="#Sampler-477"><span class="linenos">477</span></a>        <span class="c1"># plt.plot([0, len(bsq)], np.ones(2) * 0.01, &#39;--&#39;, color = &#39;black&#39;)</span>
</span><span id="Sampler-478"><a href="#Sampler-478"><span class="linenos">478</span></a>        <span class="c1"># plt.yscale(&#39;log&#39;)</span>
</span><span id="Sampler-479"><a href="#Sampler-479"><span class="linenos">479</span></a>        <span class="c1"># plt.tight_layout()</span>
</span><span id="Sampler-480"><a href="#Sampler-480"><span class="linenos">480</span></a>        <span class="c1"># plt.savefig(&#39;plots/tst_ensemble/sequential/&#39; + self.Target.name + &#39;.png&#39;)</span>
</span><span id="Sampler-481"><a href="#Sampler-481"><span class="linenos">481</span></a>        <span class="c1"># plt.close()</span>
</span><span id="Sampler-482"><a href="#Sampler-482"><span class="linenos">482</span></a>
</span><span id="Sampler-483"><a href="#Sampler-483"><span class="linenos">483</span></a>        <span class="n">cutoff_reached</span> <span class="o">=</span> <span class="n">bsq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
</span><span id="Sampler-484"><a href="#Sampler-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mf">100.</span> <span class="o">/</span> <span class="p">(</span><span class="n">find_crossing</span><span class="p">(</span><span class="n">bsq</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span><span class="p">))</span> <span class="o">*</span> <span class="n">cutoff_reached</span>
</span></pre></div>


            <div class="docstring"><p>the MCHMC (q = 0 Hamiltonian) sampler</p>
</div>


                            <div id="Sampler.__init__" class="classattr">
                                        <input id="Sampler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Sampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">Target</span><span class="p">:</span> <span class="n"><a href="#Target">Target</a></span>,</span><span class="param">	<span class="n">L</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">eps</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">integrator</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">minimal_norm</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">varEwanted</span><span class="o">=</span><span class="mf">0.0005</span>,</span><span class="param">	<span class="n">diagonal_preconditioning</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">frac_tune1</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">frac_tune2</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">frac_tune3</span><span class="o">=</span><span class="mf">0.1</span></span>)</span>

                <label class="view-source-button" for="Sampler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.__init__-51"><a href="#Sampler.__init__-51"><span class="linenos"> 51</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="Sampler.__init__-52"><a href="#Sampler.__init__-52"><span class="linenos"> 52</span></a>                 <span class="n">Target</span> <span class="p">:</span> <span class="n">Target</span><span class="p">,</span>
</span><span id="Sampler.__init__-53"><a href="#Sampler.__init__-53"><span class="linenos"> 53</span></a>                 <span class="n">L</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Sampler.__init__-54"><a href="#Sampler.__init__-54"><span class="linenos"> 54</span></a>                 <span class="n">integrator</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">minimal_norm</span><span class="p">,</span> <span class="n">varEwanted</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span>
</span><span id="Sampler.__init__-55"><a href="#Sampler.__init__-55"><span class="linenos"> 55</span></a>                 <span class="n">diagonal_preconditioning</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Sampler.__init__-56"><a href="#Sampler.__init__-56"><span class="linenos"> 56</span></a>                 <span class="n">frac_tune1</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">frac_tune3</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="Sampler.__init__-57"><a href="#Sampler.__init__-57"><span class="linenos"> 57</span></a>                 <span class="p">):</span>
</span><span id="Sampler.__init__-58"><a href="#Sampler.__init__-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="Sampler.__init__-59"><a href="#Sampler.__init__-59"><span class="linenos"> 59</span></a><span class="sd">                Target: the target distribution class</span>
</span><span id="Sampler.__init__-60"><a href="#Sampler.__init__-60"><span class="linenos"> 60</span></a>
</span><span id="Sampler.__init__-61"><a href="#Sampler.__init__-61"><span class="linenos"> 61</span></a><span class="sd">                **L**: momentum decoherence scale (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting frac_tune2 and 3 to zero (see below))</span>
</span><span id="Sampler.__init__-62"><a href="#Sampler.__init__-62"><span class="linenos"> 62</span></a>
</span><span id="Sampler.__init__-63"><a href="#Sampler.__init__-63"><span class="linenos"> 63</span></a><span class="sd">                **eps**: initial integration step-size (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting all frac_tune1 and 2 to zero (see below))</span>
</span><span id="Sampler.__init__-64"><a href="#Sampler.__init__-64"><span class="linenos"> 64</span></a>
</span><span id="Sampler.__init__-65"><a href="#Sampler.__init__-65"><span class="linenos"> 65</span></a><span class="sd">                **integrator**: dynamics.leapfrog or dynamics.minimal_norm. Typically minimal_norm performs better.</span>
</span><span id="Sampler.__init__-66"><a href="#Sampler.__init__-66"><span class="linenos"> 66</span></a>
</span><span id="Sampler.__init__-67"><a href="#Sampler.__init__-67"><span class="linenos"> 67</span></a><span class="sd">                **varEwanted**: if your posteriors are biased try smaller values (or larger values: perhaps the convergence is too slow). This is perhaps the parameter whose default value is the least well determined.</span>
</span><span id="Sampler.__init__-68"><a href="#Sampler.__init__-68"><span class="linenos"> 68</span></a>
</span><span id="Sampler.__init__-69"><a href="#Sampler.__init__-69"><span class="linenos"> 69</span></a><span class="sd">                **diagonal_preconditioning**: if you already have your own preconditioning or if you suspect diagonal preconditioning is not useful, turn this off as it can also make matters worse</span>
</span><span id="Sampler.__init__-70"><a href="#Sampler.__init__-70"><span class="linenos"> 70</span></a><span class="sd">                                          (but it can also be very useful if you did not precondition the parameters (make their posterior variances close to 1))</span>
</span><span id="Sampler.__init__-71"><a href="#Sampler.__init__-71"><span class="linenos"> 71</span></a>
</span><span id="Sampler.__init__-72"><a href="#Sampler.__init__-72"><span class="linenos"> 72</span></a><span class="sd">                **frac_tune1**: (num_samples * frac_tune1) steps will be used as a burn-in and to autotune the stepsize</span>
</span><span id="Sampler.__init__-73"><a href="#Sampler.__init__-73"><span class="linenos"> 73</span></a>
</span><span id="Sampler.__init__-74"><a href="#Sampler.__init__-74"><span class="linenos"> 74</span></a><span class="sd">                **frac_tune2**: (num_samples * frac_tune2) steps will be used to autotune L (should be around 10 effective samples long for the optimal performance)</span>
</span><span id="Sampler.__init__-75"><a href="#Sampler.__init__-75"><span class="linenos"> 75</span></a>
</span><span id="Sampler.__init__-76"><a href="#Sampler.__init__-76"><span class="linenos"> 76</span></a><span class="sd">                **frac_tune3**: (num_samples * frac_tune3) steps will be used to improve the L tuning (should be around 10 effective samples long for the optimal performance). This stage is not neccessary if the posterior is close to a Gaussian and does not change much in general.</span>
</span><span id="Sampler.__init__-77"><a href="#Sampler.__init__-77"><span class="linenos"> 77</span></a><span class="sd">                            It can be memory intensive in high dimensions so try turning it off if you have problems with the memory.</span>
</span><span id="Sampler.__init__-78"><a href="#Sampler.__init__-78"><span class="linenos"> 78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sampler.__init__-79"><a href="#Sampler.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="Sampler.__init__-80"><a href="#Sampler.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Target</span> <span class="o">=</span> <span class="n">Target</span>
</span><span id="Sampler.__init__-81"><a href="#Sampler.__init__-81"><span class="linenos"> 81</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;@private&quot;&quot;&quot;</span>
</span><span id="Sampler.__init__-82"><a href="#Sampler.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.__init__-83"><a href="#Sampler.__init__-83"><span class="linenos"> 83</span></a>
</span><span id="Sampler.__init__-84"><a href="#Sampler.__init__-84"><span class="linenos"> 84</span></a>        <span class="c1">### integrator ###</span>
</span><span id="Sampler.__init__-85"><a href="#Sampler.__init__-85"><span class="linenos"> 85</span></a>        <span class="n">hamiltonian_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span> <span class="o">=</span> <span class="n">integrator</span><span class="p">(</span><span class="n">T</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">),</span> 
</span><span id="Sampler.__init__-86"><a href="#Sampler.__init__-86"><span class="linenos"> 86</span></a>                                                                <span class="n">V</span><span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">update_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">sequential</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="Sampler.__init__-87"><a href="#Sampler.__init__-87"><span class="linenos"> 87</span></a>                                                                <span class="n">d</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.__init__-88"><a href="#Sampler.__init__-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">mclmc</span><span class="p">(</span><span class="n">hamiltonian_step</span><span class="p">,</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">partially_refresh_momentum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.__init__-89"><a href="#Sampler.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span> <span class="o">=</span> <span class="n">dynamics</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Sampler.__init__-90"><a href="#Sampler.__init__-90"><span class="linenos"> 90</span></a>
</span><span id="Sampler.__init__-91"><a href="#Sampler.__init__-91"><span class="linenos"> 91</span></a>        <span class="c1">### preconditioning ###</span>
</span><span id="Sampler.__init__-92"><a href="#Sampler.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span> <span class="o">=</span> <span class="n">diagonal_preconditioning</span>
</span><span id="Sampler.__init__-93"><a href="#Sampler.__init__-93"><span class="linenos"> 93</span></a>
</span><span id="Sampler.__init__-94"><a href="#Sampler.__init__-94"><span class="linenos"> 94</span></a>        <span class="c1">### autotuning parameters ###</span>
</span><span id="Sampler.__init__-95"><a href="#Sampler.__init__-95"><span class="linenos"> 95</span></a>
</span><span id="Sampler.__init__-96"><a href="#Sampler.__init__-96"><span class="linenos"> 96</span></a>        <span class="c1"># length of autotuning</span>
</span><span id="Sampler.__init__-97"><a href="#Sampler.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">=</span> <span class="n">frac_tune1</span> <span class="c1"># num_samples * frac_tune1 steps will be used to autotune eps</span>
</span><span id="Sampler.__init__-98"><a href="#Sampler.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">=</span> <span class="n">frac_tune2</span> <span class="c1"># num_samples * frac_tune2 steps will be used to approximately autotune L</span>
</span><span id="Sampler.__init__-99"><a href="#Sampler.__init__-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">=</span> <span class="n">frac_tune3</span> <span class="c1"># num_samples * frac_tune3 steps will be used to improve L tuning.</span>
</span><span id="Sampler.__init__-100"><a href="#Sampler.__init__-100"><span class="linenos">100</span></a>
</span><span id="Sampler.__init__-101"><a href="#Sampler.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span> <span class="o">=</span> <span class="n">varEwanted</span> <span class="c1"># 1e-3 #targeted energy variance Var[E]/d</span>
</span><span id="Sampler.__init__-102"><a href="#Sampler.__init__-102"><span class="linenos">102</span></a>        <span class="n">neff</span> <span class="o">=</span> <span class="mi">150</span> <span class="c1"># effective number of steps used to determine the stepsize in the adaptive step</span>
</span><span id="Sampler.__init__-103"><a href="#Sampler.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">neff</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">neff</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># forgeting factor in the adaptive step</span>
</span><span id="Sampler.__init__-104"><a href="#Sampler.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="o">=</span> <span class="mf">1.5</span> <span class="c1"># determines how much do we trust the stepsize predictions from the too large and too small stepsizes</span>
</span><span id="Sampler.__init__-105"><a href="#Sampler.__init__-105"><span class="linenos">105</span></a>
</span><span id="Sampler.__init__-106"><a href="#Sampler.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1">#in the third stage we set L = Lfactor * (configuration space distance bewteen independent samples)</span>
</span><span id="Sampler.__init__-107"><a href="#Sampler.__init__-107"><span class="linenos">107</span></a>
</span><span id="Sampler.__init__-108"><a href="#Sampler.__init__-108"><span class="linenos">108</span></a>
</span><span id="Sampler.__init__-109"><a href="#Sampler.__init__-109"><span class="linenos">109</span></a>        <span class="c1">### default eps and L ###</span>
</span><span id="Sampler.__init__-110"><a href="#Sampler.__init__-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="n">L</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler.__init__-111"><a href="#Sampler.__init__-111"><span class="linenos">111</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
</span><span id="Sampler.__init__-112"><a href="#Sampler.__init__-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#default value (works if the target is well preconditioned). If you are not happy with the default value and have not run the grid search we suggest using the autotuning</span>
</span><span id="Sampler.__init__-113"><a href="#Sampler.__init__-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.__init__-114"><a href="#Sampler.__init__-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="n">eps</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler.__init__-115"><a href="#Sampler.__init__-115"><span class="linenos">115</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
</span><span id="Sampler.__init__-116"><a href="#Sampler.__init__-116"><span class="linenos">116</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1">#defualt value (assumes preconditioned target and even then it might not work). Unless you have done a grid search to determine this value we suggest using the autotuning</span>
</span><span id="Sampler.__init__-117"><a href="#Sampler.__init__-117"><span class="linenos">117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
</span></pre></div>


            <div class="docstring"><p>Args:
Target: the target distribution class</p>

<p><strong>L</strong>: momentum decoherence scale (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting frac_tune2 and 3 to zero (see below))</p>

<p><strong>eps</strong>: initial integration step-size (it is then automaticaly tuned before the sampling starts unless you turn-off the tuning by setting all frac_tune1 and 2 to zero (see below))</p>

<p><strong>integrator</strong>: dynamics.leapfrog or dynamics.minimal_norm. Typically minimal_norm performs better.</p>

<p><strong>varEwanted</strong>: if your posteriors are biased try smaller values (or larger values: perhaps the convergence is too slow). This is perhaps the parameter whose default value is the least well determined.</p>

<p><strong>diagonal_preconditioning</strong>: if you already have your own preconditioning or if you suspect diagonal preconditioning is not useful, turn this off as it can also make matters worse
                          (but it can also be very useful if you did not precondition the parameters (make their posterior variances close to 1))</p>

<p><strong>frac_tune1</strong>: (num_samples * frac_tune1) steps will be used as a burn-in and to autotune the stepsize</p>

<p><strong>frac_tune2</strong>: (num_samples * frac_tune2) steps will be used to autotune L (should be around 10 effective samples long for the optimal performance)</p>

<p><strong>frac_tune3</strong>: (num_samples * frac_tune3) steps will be used to improve the L tuning (should be around 10 effective samples long for the optimal performance). This stage is not neccessary if the posterior is close to a Gaussian and does not change much in general.
            It can be memory intensive in high dimensions so try turning it off if you have problems with the memory.</p>
</div>


                            </div>
                            <div id="Sampler.sigma" class="classattr">
                                <div class="attr variable">
            <span class="name">sigma</span>

        
    </div>
    <a class="headerlink" href="#Sampler.sigma"></a>
    
    

                            </div>
                            <div id="Sampler.dynamics" class="classattr">
                                <div class="attr variable">
            <span class="name">dynamics</span>

        
    </div>
    <a class="headerlink" href="#Sampler.dynamics"></a>
    
    

                            </div>
                            <div id="Sampler.random_unit_vector" class="classattr">
                                <div class="attr variable">
            <span class="name">random_unit_vector</span>

        
    </div>
    <a class="headerlink" href="#Sampler.random_unit_vector"></a>
    
    

                            </div>
                            <div id="Sampler.diagonal_preconditioning" class="classattr">
                                <div class="attr variable">
            <span class="name">diagonal_preconditioning</span>

        
    </div>
    <a class="headerlink" href="#Sampler.diagonal_preconditioning"></a>
    
    

                            </div>
                            <div id="Sampler.frac_tune1" class="classattr">
                                <div class="attr variable">
            <span class="name">frac_tune1</span>

        
    </div>
    <a class="headerlink" href="#Sampler.frac_tune1"></a>
    
    

                            </div>
                            <div id="Sampler.frac_tune2" class="classattr">
                                <div class="attr variable">
            <span class="name">frac_tune2</span>

        
    </div>
    <a class="headerlink" href="#Sampler.frac_tune2"></a>
    
    

                            </div>
                            <div id="Sampler.frac_tune3" class="classattr">
                                <div class="attr variable">
            <span class="name">frac_tune3</span>

        
    </div>
    <a class="headerlink" href="#Sampler.frac_tune3"></a>
    
    

                            </div>
                            <div id="Sampler.varEwanted" class="classattr">
                                <div class="attr variable">
            <span class="name">varEwanted</span>

        
    </div>
    <a class="headerlink" href="#Sampler.varEwanted"></a>
    
    

                            </div>
                            <div id="Sampler.gamma" class="classattr">
                                <div class="attr variable">
            <span class="name">gamma</span>

        
    </div>
    <a class="headerlink" href="#Sampler.gamma"></a>
    
    

                            </div>
                            <div id="Sampler.sigma_xi" class="classattr">
                                <div class="attr variable">
            <span class="name">sigma_xi</span>

        
    </div>
    <a class="headerlink" href="#Sampler.sigma_xi"></a>
    
    

                            </div>
                            <div id="Sampler.Lfactor" class="classattr">
                                <div class="attr variable">
            <span class="name">Lfactor</span>

        
    </div>
    <a class="headerlink" href="#Sampler.Lfactor"></a>
    
    

                            </div>
                            <div id="Sampler.nan_reject" class="classattr">
                                        <input id="Sampler.nan_reject-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nan_reject</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">xx</span>, </span><span class="param"><span class="n">uu</span>, </span><span class="param"><span class="n">ll</span>, </span><span class="param"><span class="n">gg</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">eps_max</span>, </span><span class="param"><span class="n">dK</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.nan_reject-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.nan_reject"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.nan_reject-121"><a href="#Sampler.nan_reject-121"><span class="linenos">121</span></a>    <span class="k">def</span> <span class="nf">nan_reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">):</span>
</span><span id="Sampler.nan_reject-122"><a href="#Sampler.nan_reject-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;if there are nans, let&#39;s reduce the stepsize, and not update the state. The function returns the old state in this case.&quot;&quot;&quot;</span>
</span><span id="Sampler.nan_reject-123"><a href="#Sampler.nan_reject-123"><span class="linenos">123</span></a>        
</span><span id="Sampler.nan_reject-124"><a href="#Sampler.nan_reject-124"><span class="linenos">124</span></a>        <span class="n">nonans</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
</span><span id="Sampler.nan_reject-125"><a href="#Sampler.nan_reject-125"><span class="linenos">125</span></a>
</span><span id="Sampler.nan_reject-126"><a href="#Sampler.nan_reject-126"><span class="linenos">126</span></a>        <span class="k">return</span> <span class="n">nonans</span><span class="p">,</span> <span class="o">*</span><span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">nonans</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">new</span><span class="p">),</span> <span class="n">old</span><span class="p">),</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">dK</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>if there are nans, let's reduce the stepsize, and not update the state. The function returns the old state in this case.</p>
</div>


                            </div>
                            <div id="Sampler.dynamics_adaptive" class="classattr">
                                        <input id="Sampler.dynamics_adaptive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dynamics_adaptive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">sigma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.dynamics_adaptive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.dynamics_adaptive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.dynamics_adaptive-130"><a href="#Sampler.dynamics_adaptive-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="nf">dynamics_adaptive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler.dynamics_adaptive-131"><a href="#Sampler.dynamics_adaptive-131"><span class="linenos">131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;One step of the dynamics with the adaptive stepsize&quot;&quot;&quot;</span>
</span><span id="Sampler.dynamics_adaptive-132"><a href="#Sampler.dynamics_adaptive-132"><span class="linenos">132</span></a>
</span><span id="Sampler.dynamics_adaptive-133"><a href="#Sampler.dynamics_adaptive-133"><span class="linenos">133</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler.dynamics_adaptive-134"><a href="#Sampler.dynamics_adaptive-134"><span class="linenos">134</span></a>
</span><span id="Sampler.dynamics_adaptive-135"><a href="#Sampler.dynamics_adaptive-135"><span class="linenos">135</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Feps</span><span class="o">/</span><span class="n">Weps</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span> <span class="c1">#We use the Var[E] = O(eps^6) relation here.</span>
</span><span id="Sampler.dynamics_adaptive-136"><a href="#Sampler.dynamics_adaptive-136"><span class="linenos">136</span></a>        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="p">(</span><span class="n">eps</span> <span class="o">&gt;</span> <span class="n">eps_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps_max</span>  <span class="c1"># if the proposed stepsize is above the stepsize where we have seen divergences</span>
</span><span id="Sampler.dynamics_adaptive-137"><a href="#Sampler.dynamics_adaptive-137"><span class="linenos">137</span></a>
</span><span id="Sampler.dynamics_adaptive-138"><a href="#Sampler.dynamics_adaptive-138"><span class="linenos">138</span></a>        <span class="c1"># dynamics</span>
</span><span id="Sampler.dynamics_adaptive-139"><a href="#Sampler.dynamics_adaptive-139"><span class="linenos">139</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.dynamics_adaptive-140"><a href="#Sampler.dynamics_adaptive-140"><span class="linenos">140</span></a>
</span><span id="Sampler.dynamics_adaptive-141"><a href="#Sampler.dynamics_adaptive-141"><span class="linenos">141</span></a>        <span class="c1"># step updating</span>
</span><span id="Sampler.dynamics_adaptive-142"><a href="#Sampler.dynamics_adaptive-142"><span class="linenos">142</span></a>        <span class="n">success</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nan_reject</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">)</span>
</span><span id="Sampler.dynamics_adaptive-143"><a href="#Sampler.dynamics_adaptive-143"><span class="linenos">143</span></a>
</span><span id="Sampler.dynamics_adaptive-144"><a href="#Sampler.dynamics_adaptive-144"><span class="linenos">144</span></a>        <span class="n">DE</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>  <span class="c1"># energy difference</span>
</span><span id="Sampler.dynamics_adaptive-145"><a href="#Sampler.dynamics_adaptive-145"><span class="linenos">145</span></a>        <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">DE</span>  <span class="c1"># energy</span>
</span><span id="Sampler.dynamics_adaptive-146"><a href="#Sampler.dynamics_adaptive-146"><span class="linenos">146</span></a>        <span class="c1"># Warning: var = 0 if there were nans, but we will give it a very small weight</span>
</span><span id="Sampler.dynamics_adaptive-147"><a href="#Sampler.dynamics_adaptive-147"><span class="linenos">147</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="p">((</span><span class="n">DE</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">varEwanted</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1e-8</span>  <span class="c1"># 1e-8 is added to avoid divergences in log xi</span>
</span><span id="Sampler.dynamics_adaptive-148"><a href="#Sampler.dynamics_adaptive-148"><span class="linenos">148</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_xi</span><span class="p">)))</span>  <span class="c1"># the weight which reduces the impact of stepsizes which are much larger on much smaller than the desired one.</span>
</span><span id="Sampler.dynamics_adaptive-149"><a href="#Sampler.dynamics_adaptive-149"><span class="linenos">149</span></a>        <span class="n">Feps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Feps</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span><span class="o">/</span><span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">))</span>  <span class="c1"># Kalman update the linear combinations</span>
</span><span id="Sampler.dynamics_adaptive-150"><a href="#Sampler.dynamics_adaptive-150"><span class="linenos">150</span></a>        <span class="n">Weps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">Weps</span> <span class="o">+</span> <span class="n">w</span>
</span><span id="Sampler.dynamics_adaptive-151"><a href="#Sampler.dynamics_adaptive-151"><span class="linenos">151</span></a>
</span><span id="Sampler.dynamics_adaptive-152"><a href="#Sampler.dynamics_adaptive-152"><span class="linenos">152</span></a>        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">success</span>
</span></pre></div>


            <div class="docstring"><p>One step of the dynamics with the adaptive stepsize</p>
</div>


                            </div>
                            <div id="Sampler.get_initial_conditions" class="classattr">
                                        <input id="Sampler.get_initial_conditions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_initial_conditions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x_initial</span>, </span><span class="param"><span class="n">random_key</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.get_initial_conditions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.get_initial_conditions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.get_initial_conditions-158"><a href="#Sampler.get_initial_conditions-158"><span class="linenos">158</span></a>    <span class="k">def</span> <span class="nf">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">):</span>
</span><span id="Sampler.get_initial_conditions-159"><a href="#Sampler.get_initial_conditions-159"><span class="linenos">159</span></a>
</span><span id="Sampler.get_initial_conditions-160"><a href="#Sampler.get_initial_conditions-160"><span class="linenos">160</span></a>        <span class="c1">### random key ###</span>
</span><span id="Sampler.get_initial_conditions-161"><a href="#Sampler.get_initial_conditions-161"><span class="linenos">161</span></a>        <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler.get_initial_conditions-162"><a href="#Sampler.get_initial_conditions-162"><span class="linenos">162</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler.get_initial_conditions-163"><a href="#Sampler.get_initial_conditions-163"><span class="linenos">163</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.get_initial_conditions-164"><a href="#Sampler.get_initial_conditions-164"><span class="linenos">164</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="Sampler.get_initial_conditions-165"><a href="#Sampler.get_initial_conditions-165"><span class="linenos">165</span></a>
</span><span id="Sampler.get_initial_conditions-166"><a href="#Sampler.get_initial_conditions-166"><span class="linenos">166</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="Sampler.get_initial_conditions-167"><a href="#Sampler.get_initial_conditions-167"><span class="linenos">167</span></a>        <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="Sampler.get_initial_conditions-168"><a href="#Sampler.get_initial_conditions-168"><span class="linenos">168</span></a>            <span class="n">key</span><span class="p">,</span> <span class="n">prior_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="Sampler.get_initial_conditions-169"><a href="#Sampler.get_initial_conditions-169"><span class="linenos">169</span></a>            <span class="n">x_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">prior_key</span><span class="p">)</span>
</span><span id="Sampler.get_initial_conditions-170"><a href="#Sampler.get_initial_conditions-170"><span class="linenos">170</span></a>        
</span><span id="Sampler.get_initial_conditions-171"><a href="#Sampler.get_initial_conditions-171"><span class="linenos">171</span></a>        <span class="n">l</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">grad_nlogp</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="Sampler.get_initial_conditions-172"><a href="#Sampler.get_initial_conditions-172"><span class="linenos">172</span></a>
</span><span id="Sampler.get_initial_conditions-173"><a href="#Sampler.get_initial_conditions-173"><span class="linenos">173</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_unit_vector</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="Sampler.get_initial_conditions-174"><a href="#Sampler.get_initial_conditions-174"><span class="linenos">174</span></a>        <span class="c1">#u = - g / jnp.sqrt(jnp.sum(jnp.square(g))) #initialize momentum in the direction of the gradient of log p</span>
</span><span id="Sampler.get_initial_conditions-175"><a href="#Sampler.get_initial_conditions-175"><span class="linenos">175</span></a>
</span><span id="Sampler.get_initial_conditions-176"><a href="#Sampler.get_initial_conditions-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span>
</span></pre></div>


    

                            </div>
                            <div id="Sampler.sample" class="classattr">
                                        <input id="Sampler.sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">num_steps</span>,</span><span class="param">	<span class="n">num_chains</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">x_initial</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">random_key</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">output</span><span class="o">=&lt;</span><span class="n">Output</span><span class="o">.</span><span class="n">normal</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">thinning</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample-180"><a href="#Sampler.sample-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_initial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">random_key</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">thinning</span><span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Sampler.sample-181"><a href="#Sampler.sample-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
</span><span id="Sampler.sample-182"><a href="#Sampler.sample-182"><span class="linenos">182</span></a><span class="sd">               num_steps: number of integration steps to take.</span>
</span><span id="Sampler.sample-183"><a href="#Sampler.sample-183"><span class="linenos">183</span></a>
</span><span id="Sampler.sample-184"><a href="#Sampler.sample-184"><span class="linenos">184</span></a><span class="sd">               num_chains: number of independent chains, defaults to 1. If different than 1, jax will parallelize the computation with the number of available devices (CPU, GPU, TPU),</span>
</span><span id="Sampler.sample-185"><a href="#Sampler.sample-185"><span class="linenos">185</span></a><span class="sd">               as returned by jax.local_device_count().</span>
</span><span id="Sampler.sample-186"><a href="#Sampler.sample-186"><span class="linenos">186</span></a>
</span><span id="Sampler.sample-187"><a href="#Sampler.sample-187"><span class="linenos">187</span></a><span class="sd">               x_initial: initial condition for x, shape: (d, ). Defaults to None in which case the initial condition is drawn from the prior distribution (self.Target.prior_draw).</span>
</span><span id="Sampler.sample-188"><a href="#Sampler.sample-188"><span class="linenos">188</span></a>
</span><span id="Sampler.sample-189"><a href="#Sampler.sample-189"><span class="linenos">189</span></a><span class="sd">               random_key: jax random seed, defaults to jax.random.PRNGKey(0)</span>
</span><span id="Sampler.sample-190"><a href="#Sampler.sample-190"><span class="linenos">190</span></a>
</span><span id="Sampler.sample-191"><a href="#Sampler.sample-191"><span class="linenos">191</span></a><span class="sd">               output: determines the output of the function:</span>
</span><span id="Sampler.sample-192"><a href="#Sampler.sample-192"><span class="linenos">192</span></a>
</span><span id="Sampler.sample-193"><a href="#Sampler.sample-193"><span class="linenos">193</span></a><span class="sd">                        &#39;normal&#39;: samples, burn in steps.</span>
</span><span id="Sampler.sample-194"><a href="#Sampler.sample-194"><span class="linenos">194</span></a><span class="sd">                            samples were transformed by the Target.transform to save memory and have shape: (num_samples, len(Target.transform(x)))</span>
</span><span id="Sampler.sample-195"><a href="#Sampler.sample-195"><span class="linenos">195</span></a>
</span><span id="Sampler.sample-196"><a href="#Sampler.sample-196"><span class="linenos">196</span></a><span class="sd">                        &#39;expectation&#39;: exepcted value of transform(x)</span>
</span><span id="Sampler.sample-197"><a href="#Sampler.sample-197"><span class="linenos">197</span></a><span class="sd">                            most memory efficient. If you are after memory it might be usefull to turn off the third tuning stage</span>
</span><span id="Sampler.sample-198"><a href="#Sampler.sample-198"><span class="linenos">198</span></a>
</span><span id="Sampler.sample-199"><a href="#Sampler.sample-199"><span class="linenos">199</span></a><span class="sd">                        &#39;detailed&#39;: samples, energy error for each step, L and eps used for sampling</span>
</span><span id="Sampler.sample-200"><a href="#Sampler.sample-200"><span class="linenos">200</span></a>
</span><span id="Sampler.sample-201"><a href="#Sampler.sample-201"><span class="linenos">201</span></a><span class="sd">                        &#39;ess&#39;: Effective Sample Size per gradient evaluation, float.</span>
</span><span id="Sampler.sample-202"><a href="#Sampler.sample-202"><span class="linenos">202</span></a><span class="sd">                            In this case, self.Target.variance = &lt;x_i^2&gt;_true should be defined.</span>
</span><span id="Sampler.sample-203"><a href="#Sampler.sample-203"><span class="linenos">203</span></a>
</span><span id="Sampler.sample-204"><a href="#Sampler.sample-204"><span class="linenos">204</span></a><span class="sd">                thinning: only one every &#39;thinning&#39; steps is stored. Defaults to 1.</span>
</span><span id="Sampler.sample-205"><a href="#Sampler.sample-205"><span class="linenos">205</span></a><span class="sd">                        This is not the recommended solution to save memory. It is better to use the transform functionality.</span>
</span><span id="Sampler.sample-206"><a href="#Sampler.sample-206"><span class="linenos">206</span></a><span class="sd">                        If this is not sufficient consider saving only the expected values, by setting output= &#39;expectation&#39;.</span>
</span><span id="Sampler.sample-207"><a href="#Sampler.sample-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sampler.sample-208"><a href="#Sampler.sample-208"><span class="linenos">208</span></a>        
</span><span id="Sampler.sample-209"><a href="#Sampler.sample-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler.sample-210"><a href="#Sampler.sample-210"><span class="linenos">210</span></a>            <span class="k">for</span> <span class="n">ground_truth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;second_moments&#39;</span><span class="p">,</span> <span class="s1">&#39;variance_second_moments&#39;</span><span class="p">]:</span>
</span><span id="Sampler.sample-211"><a href="#Sampler.sample-211"><span class="linenos">211</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
</span><span id="Sampler.sample-212"><a href="#Sampler.sample-212"><span class="linenos">212</span></a>                    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.&quot;</span> <span class="o">+</span> <span class="n">ground_truth</span> <span class="o">+</span> <span class="s2">&quot; should be defined if you want to use output = ess.&quot;</span><span class="p">)</span>
</span><span id="Sampler.sample-213"><a href="#Sampler.sample-213"><span class="linenos">213</span></a>        
</span><span id="Sampler.sample-214"><a href="#Sampler.sample-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">num_chains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler.sample-215"><a href="#Sampler.sample-215"><span class="linenos">215</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span> <span class="c1">#the function which actually does the sampling</span>
</span><span id="Sampler.sample-216"><a href="#Sampler.sample-216"><span class="linenos">216</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler.sample-217"><a href="#Sampler.sample-217"><span class="linenos">217</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="Sampler.sample-218"><a href="#Sampler.sample-218"><span class="linenos">218</span></a>
</span><span id="Sampler.sample-219"><a href="#Sampler.sample-219"><span class="linenos">219</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.sample-220"><a href="#Sampler.sample-220"><span class="linenos">220</span></a>                <span class="k">return</span> <span class="n">results</span>
</span><span id="Sampler.sample-221"><a href="#Sampler.sample-221"><span class="linenos">221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.sample-222"><a href="#Sampler.sample-222"><span class="linenos">222</span></a>            <span class="n">num_cores</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">local_device_count</span><span class="p">()</span>
</span><span id="Sampler.sample-223"><a href="#Sampler.sample-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="n">random_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Sampler.sample-224"><a href="#Sampler.sample-224"><span class="linenos">224</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler.sample-225"><a href="#Sampler.sample-225"><span class="linenos">225</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.sample-226"><a href="#Sampler.sample-226"><span class="linenos">226</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">random_key</span>
</span><span id="Sampler.sample-227"><a href="#Sampler.sample-227"><span class="linenos">227</span></a>
</span><span id="Sampler.sample-228"><a href="#Sampler.sample-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="n">x_initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># draw the initial x from the prior</span>
</span><span id="Sampler.sample-229"><a href="#Sampler.sample-229"><span class="linenos">229</span></a>                <span class="n">keys_all</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Sampler.sample-230"><a href="#Sampler.sample-230"><span class="linenos">230</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">prior_draw</span><span class="p">(</span><span class="n">keys_all</span><span class="p">[</span><span class="n">num_chains</span><span class="o">+</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)])</span>
</span><span id="Sampler.sample-231"><a href="#Sampler.sample-231"><span class="linenos">231</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">keys_all</span><span class="p">[:</span><span class="n">num_chains</span><span class="p">]</span>
</span><span id="Sampler.sample-232"><a href="#Sampler.sample-232"><span class="linenos">232</span></a>
</span><span id="Sampler.sample-233"><a href="#Sampler.sample-233"><span class="linenos">233</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#initial x is given</span>
</span><span id="Sampler.sample-234"><a href="#Sampler.sample-234"><span class="linenos">234</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x_initial</span><span class="p">)</span>
</span><span id="Sampler.sample-235"><a href="#Sampler.sample-235"><span class="linenos">235</span></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">num_chains</span><span class="p">)</span>
</span><span id="Sampler.sample-236"><a href="#Sampler.sample-236"><span class="linenos">236</span></a>
</span><span id="Sampler.sample-237"><a href="#Sampler.sample-237"><span class="linenos">237</span></a>
</span><span id="Sampler.sample-238"><a href="#Sampler.sample-238"><span class="linenos">238</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_chain_sample</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="Sampler.sample-239"><a href="#Sampler.sample-239"><span class="linenos">239</span></a>
</span><span id="Sampler.sample-240"><a href="#Sampler.sample-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">num_cores</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#run the chains on parallel cores</span>
</span><span id="Sampler.sample-241"><a href="#Sampler.sample-241"><span class="linenos">241</span></a>                <span class="n">parallel_function</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span><span id="Sampler.sample-242"><a href="#Sampler.sample-242"><span class="linenos">242</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">parallel_function</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_cores</span><span class="p">,</span> <span class="n">num_chains</span> <span class="o">//</span> <span class="n">num_cores</span><span class="p">))</span>
</span><span id="Sampler.sample-243"><a href="#Sampler.sample-243"><span class="linenos">243</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler.sample-244"><a href="#Sampler.sample-244"><span class="linenos">244</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_chains</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">))</span>
</span><span id="Sampler.sample-245"><a href="#Sampler.sample-245"><span class="linenos">245</span></a>
</span><span id="Sampler.sample-246"><a href="#Sampler.sample-246"><span class="linenos">246</span></a>                <span class="c1">### reshape results ###</span>
</span><span id="Sampler.sample-247"><a href="#Sampler.sample-247"><span class="linenos">247</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span> <span class="c1">#each chain returned a tuple</span>
</span><span id="Sampler.sample-248"><a href="#Sampler.sample-248"><span class="linenos">248</span></a>                    <span class="n">results_reshaped</span> <span class="o">=</span><span class="p">[]</span>
</span><span id="Sampler.sample-249"><a href="#Sampler.sample-249"><span class="linenos">249</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
</span><span id="Sampler.sample-250"><a href="#Sampler.sample-250"><span class="linenos">250</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="Sampler.sample-251"><a href="#Sampler.sample-251"><span class="linenos">251</span></a>                        <span class="n">results_reshaped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">))]))</span>
</span><span id="Sampler.sample-252"><a href="#Sampler.sample-252"><span class="linenos">252</span></a>                    <span class="k">return</span> <span class="n">results_reshaped</span>
</span><span id="Sampler.sample-253"><a href="#Sampler.sample-253"><span class="linenos">253</span></a>
</span><span id="Sampler.sample-254"><a href="#Sampler.sample-254"><span class="linenos">254</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.sample-255"><a href="#Sampler.sample-255"><span class="linenos">255</span></a>                    <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">num_chains</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">))])</span>
</span><span id="Sampler.sample-256"><a href="#Sampler.sample-256"><span class="linenos">256</span></a>
</span><span id="Sampler.sample-257"><a href="#Sampler.sample-257"><span class="linenos">257</span></a>
</span><span id="Sampler.sample-258"><a href="#Sampler.sample-258"><span class="linenos">258</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1">#run chains serially on a single core</span>
</span><span id="Sampler.sample-259"><a href="#Sampler.sample-259"><span class="linenos">259</span></a>
</span><span id="Sampler.sample-260"><a href="#Sampler.sample-260"><span class="linenos">260</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chains</span><span class="p">))</span>
</span><span id="Sampler.sample-261"><a href="#Sampler.sample-261"><span class="linenos">261</span></a>
</span><span id="Sampler.sample-262"><a href="#Sampler.sample-262"><span class="linenos">262</span></a>                <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler.sample-263"><a href="#Sampler.sample-263"><span class="linenos">263</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="Sampler.sample-264"><a href="#Sampler.sample-264"><span class="linenos">264</span></a>
</span><span id="Sampler.sample-265"><a href="#Sampler.sample-265"><span class="linenos">265</span></a>                <span class="k">else</span><span class="p">:</span> 
</span><span id="Sampler.sample-266"><a href="#Sampler.sample-266"><span class="linenos">266</span></a>                    <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Args:
num_steps: number of integration steps to take.</p>

<p>num_chains: number of independent chains, defaults to 1. If different than 1, jax will parallelize the computation with the number of available devices (CPU, GPU, TPU),
as returned by jax.local_device_count().</p>

<p>x_initial: initial condition for x, shape: (d, ). Defaults to None in which case the initial condition is drawn from the prior distribution (self.Target.prior_draw).</p>

<p>random_key: jax random seed, defaults to jax.random.PRNGKey(0)</p>

<p>output: determines the output of the function:</p>

<pre><code>     'normal': samples, burn in steps.
         samples were transformed by the <a href="#Target.transform">Target.transform</a> to save memory and have shape: (num_samples, len(<a href="#Target.transform">Target.transform</a>(x)))

     'expectation': exepcted value of transform(x)
         most memory efficient. If you are after memory it might be usefull to turn off the third tuning stage

     'detailed': samples, energy error for each step, L and eps used for sampling

     'ess': Effective Sample Size per gradient evaluation, float.
         In this case, self.Target.variance = &lt;x_i^2&gt;_true should be defined.
</code></pre>

<p>thinning: only one every 'thinning' steps is stored. Defaults to 1.
         This is not the recommended solution to save memory. It is better to use the transform functionality.
         If this is not sufficient consider saving only the expected values, by setting output= 'expectation'.</p>
</div>


                            </div>
                            <div id="Sampler.single_chain_sample" class="classattr">
                                        <input id="Sampler.single_chain_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">single_chain_sample</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x_initial</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">output</span>, </span><span class="param"><span class="n">thinning</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.single_chain_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.single_chain_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.single_chain_sample-270"><a href="#Sampler.single_chain_sample-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="nf">single_chain_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler.single_chain_sample-271"><a href="#Sampler.single_chain_sample-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;sampling routine. It is called by self.sample&quot;&quot;&quot;</span>
</span><span id="Sampler.single_chain_sample-272"><a href="#Sampler.single_chain_sample-272"><span class="linenos">272</span></a>        
</span><span id="Sampler.single_chain_sample-273"><a href="#Sampler.single_chain_sample-273"><span class="linenos">273</span></a>        <span class="c1">### initial conditions ###</span>
</span><span id="Sampler.single_chain_sample-274"><a href="#Sampler.single_chain_sample-274"><span class="linenos">274</span></a>        <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_conditions</span><span class="p">(</span><span class="n">x_initial</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-275"><a href="#Sampler.single_chain_sample-275"><span class="linenos">275</span></a>        <span class="n">L</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="c1">#the initial values, given at the class initialization (or set to the default values)</span>
</span><span id="Sampler.single_chain_sample-276"><a href="#Sampler.single_chain_sample-276"><span class="linenos">276</span></a>
</span><span id="Sampler.single_chain_sample-277"><a href="#Sampler.single_chain_sample-277"><span class="linenos">277</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="c1"># jnp.ones(self.Target.d)  # no diagonal preconditioning</span>
</span><span id="Sampler.single_chain_sample-278"><a href="#Sampler.single_chain_sample-278"><span class="linenos">278</span></a>
</span><span id="Sampler.single_chain_sample-279"><a href="#Sampler.single_chain_sample-279"><span class="linenos">279</span></a>        <span class="c1">### auto-tune the hyperparameters L and eps ###</span>
</span><span id="Sampler.single_chain_sample-280"><a href="#Sampler.single_chain_sample-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-281"><a href="#Sampler.single_chain_sample-281"><span class="linenos">281</span></a>            <span class="n">steps1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune1</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-282"><a href="#Sampler.single_chain_sample-282"><span class="linenos">282</span></a>            <span class="n">steps2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune2</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-283"><a href="#Sampler.single_chain_sample-283"><span class="linenos">283</span></a>            <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps1</span><span class="p">,</span> <span class="n">steps2</span><span class="p">)</span> <span class="c1">#the cheap tuning (100 steps)</span>
</span><span id="Sampler.single_chain_sample-284"><a href="#Sampler.single_chain_sample-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#if we want to further improve L tuning we go to the second stage (which is a bit slower)</span>
</span><span id="Sampler.single_chain_sample-285"><a href="#Sampler.single_chain_sample-285"><span class="linenos">285</span></a>                <span class="n">steps3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_tune3</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-286"><a href="#Sampler.single_chain_sample-286"><span class="linenos">286</span></a>                <span class="n">L</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tune3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">steps3</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-287"><a href="#Sampler.single_chain_sample-287"><span class="linenos">287</span></a>
</span><span id="Sampler.single_chain_sample-288"><a href="#Sampler.single_chain_sample-288"><span class="linenos">288</span></a>        <span class="c1">### sampling ###</span>
</span><span id="Sampler.single_chain_sample-289"><a href="#Sampler.single_chain_sample-289"><span class="linenos">289</span></a>
</span><span id="Sampler.single_chain_sample-290"><a href="#Sampler.single_chain_sample-290"><span class="linenos">290</span></a>        
</span><span id="Sampler.single_chain_sample-291"><a href="#Sampler.single_chain_sample-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">normal</span> <span class="ow">or</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-292"><a href="#Sampler.single_chain_sample-292"><span class="linenos">292</span></a>            <span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_normal</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-293"><a href="#Sampler.single_chain_sample-293"><span class="linenos">293</span></a>            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">detailed</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-294"><a href="#Sampler.single_chain_sample-294"><span class="linenos">294</span></a>                <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span>
</span><span id="Sampler.single_chain_sample-295"><a href="#Sampler.single_chain_sample-295"><span class="linenos">295</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-296"><a href="#Sampler.single_chain_sample-296"><span class="linenos">296</span></a>                <span class="k">return</span> <span class="n">X</span>
</span><span id="Sampler.single_chain_sample-297"><a href="#Sampler.single_chain_sample-297"><span class="linenos">297</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">expectation</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-298"><a href="#Sampler.single_chain_sample-298"><span class="linenos">298</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_expectation</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-299"><a href="#Sampler.single_chain_sample-299"><span class="linenos">299</span></a>
</span><span id="Sampler.single_chain_sample-300"><a href="#Sampler.single_chain_sample-300"><span class="linenos">300</span></a>        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="n">OutputType</span><span class="o">.</span><span class="n">ess</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-301"><a href="#Sampler.single_chain_sample-301"><span class="linenos">301</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-302"><a href="#Sampler.single_chain_sample-302"><span class="linenos">302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance</span>
</span><span id="Sampler.single_chain_sample-303"><a href="#Sampler.single_chain_sample-303"><span class="linenos">303</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="Sampler.single_chain_sample-304"><a href="#Sampler.single_chain_sample-304"><span class="linenos">304</span></a>                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Target.variance should be defined&quot;</span><span class="p">)</span>
</span><span id="Sampler.single_chain_sample-305"><a href="#Sampler.single_chain_sample-305"><span class="linenos">305</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ess</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>sampling routine. It is called by self.sample</p>
</div>


                            </div>
                            <div id="Sampler.sample_normal" class="classattr">
                                        <input id="Sampler.sample_normal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_normal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span>, </span><span class="param"><span class="n">thinning</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample_normal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample_normal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample_normal-310"><a href="#Sampler.sample_normal-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">sample_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler.sample_normal-311"><a href="#Sampler.sample_normal-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler.sample_normal-312"><a href="#Sampler.sample_normal-312"><span class="linenos">312</span></a>        
</span><span id="Sampler.sample_normal-313"><a href="#Sampler.sample_normal-313"><span class="linenos">313</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_normal-314"><a href="#Sampler.sample_normal-314"><span class="linenos">314</span></a>
</span><span id="Sampler.sample_normal-315"><a href="#Sampler.sample_normal-315"><span class="linenos">315</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler.sample_normal-316"><a href="#Sampler.sample_normal-316"><span class="linenos">316</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.sample_normal-317"><a href="#Sampler.sample_normal-317"><span class="linenos">317</span></a>
</span><span id="Sampler.sample_normal-318"><a href="#Sampler.sample_normal-318"><span class="linenos">318</span></a>            <span class="c1"># left in as a comment since it may be useful when experimenting with neighbour lists in MD</span>
</span><span id="Sampler.sample_normal-319"><a href="#Sampler.sample_normal-319"><span class="linenos">319</span></a>            <span class="c1"># if self.Target.nbrs:</span>
</span><span id="Sampler.sample_normal-320"><a href="#Sampler.sample_normal-320"><span class="linenos">320</span></a>            <span class="c1">#     self.Target.nbrs = self.Target.nbrs.update(jnp.reshape(xx, (-1,3)), neighbor=self.Target.nbrs)</span>
</span><span id="Sampler.sample_normal-321"><a href="#Sampler.sample_normal-321"><span class="linenos">321</span></a>            
</span><span id="Sampler.sample_normal-322"><a href="#Sampler.sample_normal-322"><span class="linenos">322</span></a>            <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler.sample_normal-323"><a href="#Sampler.sample_normal-323"><span class="linenos">323</span></a>            
</span><span id="Sampler.sample_normal-324"><a href="#Sampler.sample_normal-324"><span class="linenos">324</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">ll</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>
</span><span id="Sampler.sample_normal-325"><a href="#Sampler.sample_normal-325"><span class="linenos">325</span></a>
</span><span id="Sampler.sample_normal-326"><a href="#Sampler.sample_normal-326"><span class="linenos">326</span></a>
</span><span id="Sampler.sample_normal-327"><a href="#Sampler.sample_normal-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="n">thinning</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler.sample_normal-328"><a href="#Sampler.sample_normal-328"><span class="linenos">328</span></a>            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler.sample_normal-329"><a href="#Sampler.sample_normal-329"><span class="linenos">329</span></a>
</span><span id="Sampler.sample_normal-330"><a href="#Sampler.sample_normal-330"><span class="linenos">330</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.sample_normal-331"><a href="#Sampler.sample_normal-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_thinning</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Stores transform(x) for each step.</p>
</div>


                            </div>
                            <div id="Sampler.sample_thinning" class="classattr">
                                        <input id="Sampler.sample_thinning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_thinning</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span>, </span><span class="param"><span class="n">thinning</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample_thinning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample_thinning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample_thinning-334"><a href="#Sampler.sample_thinning-334"><span class="linenos">334</span></a>    <span class="k">def</span> <span class="nf">sample_thinning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">thinning</span><span class="p">):</span>
</span><span id="Sampler.sample_thinning-335"><a href="#Sampler.sample_thinning-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores transform(x) for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler.sample_thinning-336"><a href="#Sampler.sample_thinning-336"><span class="linenos">336</span></a>
</span><span id="Sampler.sample_thinning-337"><a href="#Sampler.sample_thinning-337"><span class="linenos">337</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_thinning-338"><a href="#Sampler.sample_thinning-338"><span class="linenos">338</span></a>
</span><span id="Sampler.sample_thinning-339"><a href="#Sampler.sample_thinning-339"><span class="linenos">339</span></a>            <span class="k">def</span> <span class="nf">substep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_thinning-340"><a href="#Sampler.sample_thinning-340"><span class="linenos">340</span></a>                <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler.sample_thinning-341"><a href="#Sampler.sample_thinning-341"><span class="linenos">341</span></a>                <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.sample_thinning-342"><a href="#Sampler.sample_thinning-342"><span class="linenos">342</span></a>                <span class="n">de</span> <span class="o">=</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler.sample_thinning-343"><a href="#Sampler.sample_thinning-343"><span class="linenos">343</span></a>                <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="kc">None</span>
</span><span id="Sampler.sample_thinning-344"><a href="#Sampler.sample_thinning-344"><span class="linenos">344</span></a>
</span><span id="Sampler.sample_thinning-345"><a href="#Sampler.sample_thinning-345"><span class="linenos">345</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">substep</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#do &#39;thinning&#39; steps without saving</span>
</span><span id="Sampler.sample_thinning-346"><a href="#Sampler.sample_thinning-346"><span class="linenos">346</span></a>
</span><span id="Sampler.sample_thinning-347"><a href="#Sampler.sample_thinning-347"><span class="linenos">347</span></a>            <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#save one sample</span>
</span><span id="Sampler.sample_thinning-348"><a href="#Sampler.sample_thinning-348"><span class="linenos">348</span></a>
</span><span id="Sampler.sample_thinning-349"><a href="#Sampler.sample_thinning-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps</span> <span class="o">//</span> <span class="n">thinning</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Stores transform(x) for each step.</p>
</div>


                            </div>
                            <div id="Sampler.sample_expectation" class="classattr">
                                        <input id="Sampler.sample_expectation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_expectation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample_expectation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample_expectation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample_expectation-353"><a href="#Sampler.sample_expectation-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">sample_expectation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler.sample_expectation-354"><a href="#Sampler.sample_expectation-354"><span class="linenos">354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores no history but keeps the expected value of transform(x).&quot;&quot;&quot;</span>
</span><span id="Sampler.sample_expectation-355"><a href="#Sampler.sample_expectation-355"><span class="linenos">355</span></a>        
</span><span id="Sampler.sample_expectation-356"><a href="#Sampler.sample_expectation-356"><span class="linenos">356</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_expectation-357"><a href="#Sampler.sample_expectation-357"><span class="linenos">357</span></a>            
</span><span id="Sampler.sample_expectation-358"><a href="#Sampler.sample_expectation-358"><span class="linenos">358</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.sample_expectation-359"><a href="#Sampler.sample_expectation-359"><span class="linenos">359</span></a>            
</span><span id="Sampler.sample_expectation-360"><a href="#Sampler.sample_expectation-360"><span class="linenos">360</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="kc">None</span>
</span><span id="Sampler.sample_expectation-361"><a href="#Sampler.sample_expectation-361"><span class="linenos">361</span></a>
</span><span id="Sampler.sample_expectation-362"><a href="#Sampler.sample_expectation-362"><span class="linenos">362</span></a>        <span class="n">state1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">)</span>
</span><span id="Sampler.sample_expectation-363"><a href="#Sampler.sample_expectation-363"><span class="linenos">363</span></a>        <span class="n">state2</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Sampler.sample_expectation-364"><a href="#Sampler.sample_expectation-364"><span class="linenos">364</span></a>        <span class="k">return</span>  <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="p">(</span><span class="n">state1</span><span class="p">,</span> <span class="n">state2</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_steps</span>
</span></pre></div>


            <div class="docstring"><p>Stores no history but keeps the expected value of transform(x).</p>
</div>


                            </div>
                            <div id="Sampler.sample_ess" class="classattr">
                                        <input id="Sampler.sample_ess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_ess</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample_ess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample_ess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample_ess-369"><a href="#Sampler.sample_ess-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">sample_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler.sample_ess-370"><a href="#Sampler.sample_ess-370"><span class="linenos">370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores the bias of the second moments for each step.&quot;&quot;&quot;</span>
</span><span id="Sampler.sample_ess-371"><a href="#Sampler.sample_ess-371"><span class="linenos">371</span></a>        
</span><span id="Sampler.sample_ess-372"><a href="#Sampler.sample_ess-372"><span class="linenos">372</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state_track</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_ess-373"><a href="#Sampler.sample_ess-373"><span class="linenos">373</span></a>            
</span><span id="Sampler.sample_ess-374"><a href="#Sampler.sample_ess-374"><span class="linenos">374</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Sampler.sample_ess-375"><a href="#Sampler.sample_ess-375"><span class="linenos">375</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.sample_ess-376"><a href="#Sampler.sample_ess-376"><span class="linenos">376</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state_track</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler.sample_ess-377"><a href="#Sampler.sample_ess-377"><span class="linenos">377</span></a>        
</span><span id="Sampler.sample_ess-378"><a href="#Sampler.sample_ess-378"><span class="linenos">378</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">F2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler.sample_ess-379"><a href="#Sampler.sample_ess-379"><span class="linenos">379</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Sampler.sample_ess-380"><a href="#Sampler.sample_ess-380"><span class="linenos">380</span></a>            <span class="n">bias_d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">second_moments</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">variance_second_moments</span>
</span><span id="Sampler.sample_ess-381"><a href="#Sampler.sample_ess-381"><span class="linenos">381</span></a>            <span class="n">bias</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bias_d</span><span class="p">)</span>
</span><span id="Sampler.sample_ess-382"><a href="#Sampler.sample_ess-382"><span class="linenos">382</span></a>            <span class="c1">#bias = jnp.max(bias_d)</span>
</span><span id="Sampler.sample_ess-383"><a href="#Sampler.sample_ess-383"><span class="linenos">383</span></a>
</span><span id="Sampler.sample_ess-384"><a href="#Sampler.sample_ess-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">bias</span>
</span><span id="Sampler.sample_ess-385"><a href="#Sampler.sample_ess-385"><span class="linenos">385</span></a>
</span><span id="Sampler.sample_ess-386"><a href="#Sampler.sample_ess-386"><span class="linenos">386</span></a>        
</span><span id="Sampler.sample_ess-387"><a href="#Sampler.sample_ess-387"><span class="linenos">387</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)))),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="Sampler.sample_ess-388"><a href="#Sampler.sample_ess-388"><span class="linenos">388</span></a>
</span><span id="Sampler.sample_ess-389"><a href="#Sampler.sample_ess-389"><span class="linenos">389</span></a>        <span class="c1">#nans = jnp.any(jnp.isnan(b))</span>
</span><span id="Sampler.sample_ess-390"><a href="#Sampler.sample_ess-390"><span class="linenos">390</span></a>
</span><span id="Sampler.sample_ess-391"><a href="#Sampler.sample_ess-391"><span class="linenos">391</span></a>        <span class="k">return</span> <span class="n">b</span> <span class="c1">#+ nans * 1e5 #return a large bias if there were nans</span>
</span></pre></div>


            <div class="docstring"><p>Stores the bias of the second moments for each step.</p>
</div>


                            </div>
                            <div id="Sampler.tune12" class="classattr">
                                        <input id="Sampler.tune12-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tune12</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x</span>,</span><span class="param">	<span class="n">u</span>,</span><span class="param">	<span class="n">l</span>,</span><span class="param">	<span class="n">g</span>,</span><span class="param">	<span class="n">random_key</span>,</span><span class="param">	<span class="n">L_given</span>,</span><span class="param">	<span class="n">eps</span>,</span><span class="param">	<span class="n">sigma_given</span>,</span><span class="param">	<span class="n">num_steps1</span>,</span><span class="param">	<span class="n">num_steps2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.tune12-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.tune12"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.tune12-396"><a href="#Sampler.tune12-396"><span class="linenos">396</span></a>    <span class="k">def</span> <span class="nf">tune12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L_given</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma_given</span><span class="p">,</span> <span class="n">num_steps1</span><span class="p">,</span> <span class="n">num_steps2</span><span class="p">):</span>
</span><span id="Sampler.tune12-397"><a href="#Sampler.tune12-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;cheap hyperparameter tuning&quot;&quot;&quot;</span>
</span><span id="Sampler.tune12-398"><a href="#Sampler.tune12-398"><span class="linenos">398</span></a>        
</span><span id="Sampler.tune12-399"><a href="#Sampler.tune12-399"><span class="linenos">399</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_given</span>
</span><span id="Sampler.tune12-400"><a href="#Sampler.tune12-400"><span class="linenos">400</span></a>
</span><span id="Sampler.tune12-401"><a href="#Sampler.tune12-401"><span class="linenos">401</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">outer_weight</span><span class="p">):</span>
</span><span id="Sampler.tune12-402"><a href="#Sampler.tune12-402"><span class="linenos">402</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;one adaptive step of the dynamics&quot;&quot;&quot;</span>
</span><span id="Sampler.tune12-403"><a href="#Sampler.tune12-403"><span class="linenos">403</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics_adaptive</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">L</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.tune12-404"><a href="#Sampler.tune12-404"><span class="linenos">404</span></a>            <span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Sampler.tune12-405"><a href="#Sampler.tune12-405"><span class="linenos">405</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">outer_weight</span> <span class="o">*</span> <span class="n">eps</span>
</span><span id="Sampler.tune12-406"><a href="#Sampler.tune12-406"><span class="linenos">406</span></a>            <span class="n">zero_prevention</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">outer_weight</span>
</span><span id="Sampler.tune12-407"><a href="#Sampler.tune12-407"><span class="linenos">407</span></a>            <span class="n">F1</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler.tune12-408"><a href="#Sampler.tune12-408"><span class="linenos">408</span></a>            <span class="n">F2</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">F2</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">zero_prevention</span><span class="p">)</span>  <span class="c1"># Update &lt;f(x)&gt; with a Kalman filter</span>
</span><span id="Sampler.tune12-409"><a href="#Sampler.tune12-409"><span class="linenos">409</span></a>            <span class="n">W</span> <span class="o">+=</span> <span class="n">w</span>
</span><span id="Sampler.tune12-410"><a href="#Sampler.tune12-410"><span class="linenos">410</span></a>
</span><span id="Sampler.tune12-411"><a href="#Sampler.tune12-411"><span class="linenos">411</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">Feps</span><span class="p">,</span> <span class="n">Weps</span><span class="p">,</span> <span class="n">eps_max</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span><span class="p">)),</span> <span class="n">eps</span>
</span><span id="Sampler.tune12-412"><a href="#Sampler.tune12-412"><span class="linenos">412</span></a>
</span><span id="Sampler.tune12-413"><a href="#Sampler.tune12-413"><span class="linenos">413</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="n">L_given</span>
</span><span id="Sampler.tune12-414"><a href="#Sampler.tune12-414"><span class="linenos">414</span></a>
</span><span id="Sampler.tune12-415"><a href="#Sampler.tune12-415"><span class="linenos">415</span></a>        <span class="c1"># we use the last num_steps2 to compute the diagonal preconditioner</span>
</span><span id="Sampler.tune12-416"><a href="#Sampler.tune12-416"><span class="linenos">416</span></a>        <span class="n">outer_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_steps2</span><span class="p">)))</span>
</span><span id="Sampler.tune12-417"><a href="#Sampler.tune12-417"><span class="linenos">417</span></a>
</span><span id="Sampler.tune12-418"><a href="#Sampler.tune12-418"><span class="linenos">418</span></a>        <span class="c1">#initial state</span>
</span><span id="Sampler.tune12-419"><a href="#Sampler.tune12-419"><span class="linenos">419</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</span><span id="Sampler.tune12-420"><a href="#Sampler.tune12-420"><span class="linenos">420</span></a>        <span class="c1"># run the steps</span>
</span><span id="Sampler.tune12-421"><a href="#Sampler.tune12-421"><span class="linenos">421</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">outer_weights</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span> <span class="n">num_steps1</span> <span class="o">+</span> <span class="n">num_steps2</span><span class="p">)</span>
</span><span id="Sampler.tune12-422"><a href="#Sampler.tune12-422"><span class="linenos">422</span></a>        <span class="c1"># determine L</span>
</span><span id="Sampler.tune12-423"><a href="#Sampler.tune12-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">num_steps2</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="Sampler.tune12-424"><a href="#Sampler.tune12-424"><span class="linenos">424</span></a>            <span class="n">F1</span><span class="p">,</span> <span class="n">F2</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Sampler.tune12-425"><a href="#Sampler.tune12-425"><span class="linenos">425</span></a>            <span class="n">variances</span> <span class="o">=</span> <span class="n">F2</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">F1</span><span class="p">)</span>
</span><span id="Sampler.tune12-426"><a href="#Sampler.tune12-426"><span class="linenos">426</span></a>            <span class="n">sigma2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="Sampler.tune12-427"><a href="#Sampler.tune12-427"><span class="linenos">427</span></a>
</span><span id="Sampler.tune12-428"><a href="#Sampler.tune12-428"><span class="linenos">428</span></a>            <span class="c1"># optionally we do the diagonal preconditioning (and readjust the stepsize)</span>
</span><span id="Sampler.tune12-429"><a href="#Sampler.tune12-429"><span class="linenos">429</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal_preconditioning</span><span class="p">:</span>
</span><span id="Sampler.tune12-430"><a href="#Sampler.tune12-430"><span class="linenos">430</span></a>
</span><span id="Sampler.tune12-431"><a href="#Sampler.tune12-431"><span class="linenos">431</span></a>                <span class="c1"># diagonal preconditioning</span>
</span><span id="Sampler.tune12-432"><a href="#Sampler.tune12-432"><span class="linenos">432</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>
</span><span id="Sampler.tune12-433"><a href="#Sampler.tune12-433"><span class="linenos">433</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.tune12-434"><a href="#Sampler.tune12-434"><span class="linenos">434</span></a>
</span><span id="Sampler.tune12-435"><a href="#Sampler.tune12-435"><span class="linenos">435</span></a>                <span class="c1">#readjust the stepsize</span>
</span><span id="Sampler.tune12-436"><a href="#Sampler.tune12-436"><span class="linenos">436</span></a>                <span class="n">steps</span> <span class="o">=</span> <span class="n">num_steps2</span> <span class="o">//</span> <span class="mi">3</span> <span class="c1">#we do some small number of steps</span>
</span><span id="Sampler.tune12-437"><a href="#Sampler.tune12-437"><span class="linenos">437</span></a>                <span class="n">state</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span> <span class="n">state</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="Sampler.tune12-438"><a href="#Sampler.tune12-438"><span class="linenos">438</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.tune12-439"><a href="#Sampler.tune12-439"><span class="linenos">439</span></a>                <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</span><span id="Sampler.tune12-440"><a href="#Sampler.tune12-440"><span class="linenos">440</span></a>
</span><span id="Sampler.tune12-441"><a href="#Sampler.tune12-441"><span class="linenos">441</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># the final state</span>
</span><span id="Sampler.tune12-442"><a href="#Sampler.tune12-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="c1">#return the tuned hyperparameters and the final state</span>
</span></pre></div>


            <div class="docstring"><p>cheap hyperparameter tuning</p>
</div>


                            </div>
                            <div id="Sampler.tune3" class="classattr">
                                        <input id="Sampler.tune3-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tune3</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span>, </span><span class="param"><span class="n">num_steps</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.tune3-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.tune3"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.tune3-446"><a href="#Sampler.tune3-446"><span class="linenos">446</span></a>    <span class="k">def</span> <span class="nf">tune3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
</span><span id="Sampler.tune3-447"><a href="#Sampler.tune3-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;determine L by the autocorrelations (around 10 effective samples are needed for this to be accurate)&quot;&quot;&quot;</span>
</span><span id="Sampler.tune3-448"><a href="#Sampler.tune3-448"><span class="linenos">448</span></a>        <span class="n">X</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_full</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.tune3-449"><a href="#Sampler.tune3-449"><span class="linenos">449</span></a>        <span class="n">ESS</span> <span class="o">=</span> <span class="n">ess_corr</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="Sampler.tune3-450"><a href="#Sampler.tune3-450"><span class="linenos">450</span></a>        <span class="n">Lnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lfactor</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">/</span> <span class="n">ESS</span> <span class="c1"># = 0.4 * correlation length</span>
</span><span id="Sampler.tune3-451"><a href="#Sampler.tune3-451"><span class="linenos">451</span></a>
</span><span id="Sampler.tune3-452"><a href="#Sampler.tune3-452"><span class="linenos">452</span></a>        <span class="k">return</span> <span class="n">Lnew</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span></pre></div>


            <div class="docstring"><p>determine L by the autocorrelations (around 10 effective samples are needed for this to be accurate)</p>
</div>


                            </div>
                            <div id="Sampler.sample_full" class="classattr">
                                        <input id="Sampler.sample_full-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_full</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">num_steps</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">u</span>, </span><span class="param"><span class="n">l</span>, </span><span class="param"><span class="n">g</span>, </span><span class="param"><span class="n">random_key</span>, </span><span class="param"><span class="n">L</span>, </span><span class="param"><span class="n">eps</span>, </span><span class="param"><span class="n">sigma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.sample_full-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.sample_full"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.sample_full-455"><a href="#Sampler.sample_full-455"><span class="linenos">455</span></a>    <span class="k">def</span> <span class="nf">sample_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">random_key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
</span><span id="Sampler.sample_full-456"><a href="#Sampler.sample_full-456"><span class="linenos">456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores full x for each step. Used in tune2.&quot;&quot;&quot;</span>
</span><span id="Sampler.sample_full-457"><a href="#Sampler.sample_full-457"><span class="linenos">457</span></a>
</span><span id="Sampler.sample_full-458"><a href="#Sampler.sample_full-458"><span class="linenos">458</span></a>        <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">useless</span><span class="p">):</span>
</span><span id="Sampler.sample_full-459"><a href="#Sampler.sample_full-459"><span class="linenos">459</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span>
</span><span id="Sampler.sample_full-460"><a href="#Sampler.sample_full-460"><span class="linenos">460</span></a>            <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">kinetic_change</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="Sampler.sample_full-461"><a href="#Sampler.sample_full-461"><span class="linenos">461</span></a>            <span class="n">EE</span> <span class="o">=</span> <span class="n">E</span> <span class="o">+</span> <span class="n">kinetic_change</span> <span class="o">+</span> <span class="n">ll</span> <span class="o">-</span> <span class="n">l</span>
</span><span id="Sampler.sample_full-462"><a href="#Sampler.sample_full-462"><span class="linenos">462</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">xx</span>
</span><span id="Sampler.sample_full-463"><a href="#Sampler.sample_full-463"><span class="linenos">463</span></a>
</span><span id="Sampler.sample_full-464"><a href="#Sampler.sample_full-464"><span class="linenos">464</span></a>        <span class="n">state</span><span class="p">,</span> <span class="n">track</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">random_key</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</span><span id="Sampler.sample_full-465"><a href="#Sampler.sample_full-465"><span class="linenos">465</span></a>        <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">state</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="Sampler.sample_full-466"><a href="#Sampler.sample_full-466"><span class="linenos">466</span></a>        <span class="k">return</span> <span class="n">track</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key</span>
</span></pre></div>


            <div class="docstring"><p>Stores full x for each step. Used in tune2.</p>
</div>


                            </div>
                            <div id="Sampler.bias_plot" class="classattr">
                                        <input id="Sampler.bias_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bias_plot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">results</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Sampler.bias_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sampler.bias_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sampler.bias_plot-470"><a href="#Sampler.bias_plot-470"><span class="linenos">470</span></a>    <span class="k">def</span> <span class="nf">bias_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
</span><span id="Sampler.bias_plot-471"><a href="#Sampler.bias_plot-471"><span class="linenos">471</span></a>        <span class="c1">#bsq = jnp.average(results.reshape(results.shape[0] * results.shape[1], results.shape[2]), axis = 0)</span>
</span><span id="Sampler.bias_plot-472"><a href="#Sampler.bias_plot-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Sampler.bias_plot-473"><a href="#Sampler.bias_plot-473"><span class="linenos">473</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Sampler.bias_plot-474"><a href="#Sampler.bias_plot-474"><span class="linenos">474</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sampler.bias_plot-475"><a href="#Sampler.bias_plot-475"><span class="linenos">475</span></a>            <span class="n">bsq</span> <span class="o">=</span> <span class="n">results</span>    
</span><span id="Sampler.bias_plot-476"><a href="#Sampler.bias_plot-476"><span class="linenos">476</span></a>        <span class="c1"># plt.plot(bsq)</span>
</span><span id="Sampler.bias_plot-477"><a href="#Sampler.bias_plot-477"><span class="linenos">477</span></a>        <span class="c1"># plt.plot([0, len(bsq)], np.ones(2) * 0.01, &#39;--&#39;, color = &#39;black&#39;)</span>
</span><span id="Sampler.bias_plot-478"><a href="#Sampler.bias_plot-478"><span class="linenos">478</span></a>        <span class="c1"># plt.yscale(&#39;log&#39;)</span>
</span><span id="Sampler.bias_plot-479"><a href="#Sampler.bias_plot-479"><span class="linenos">479</span></a>        <span class="c1"># plt.tight_layout()</span>
</span><span id="Sampler.bias_plot-480"><a href="#Sampler.bias_plot-480"><span class="linenos">480</span></a>        <span class="c1"># plt.savefig(&#39;plots/tst_ensemble/sequential/&#39; + self.Target.name + &#39;.png&#39;)</span>
</span><span id="Sampler.bias_plot-481"><a href="#Sampler.bias_plot-481"><span class="linenos">481</span></a>        <span class="c1"># plt.close()</span>
</span><span id="Sampler.bias_plot-482"><a href="#Sampler.bias_plot-482"><span class="linenos">482</span></a>
</span><span id="Sampler.bias_plot-483"><a href="#Sampler.bias_plot-483"><span class="linenos">483</span></a>        <span class="n">cutoff_reached</span> <span class="o">=</span> <span class="n">bsq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.01</span>
</span><span id="Sampler.bias_plot-484"><a href="#Sampler.bias_plot-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mf">100.</span> <span class="o">/</span> <span class="p">(</span><span class="n">find_crossing</span><span class="p">(</span><span class="n">bsq</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_evals_per_step</span><span class="p">))</span> <span class="o">*</span> <span class="n">cutoff_reached</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="find_crossing">
                            <input id="find_crossing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_crossing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">array</span>, </span><span class="param"><span class="n">cutoff</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="find_crossing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#find_crossing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="find_crossing-487"><a href="#find_crossing-487"><span class="linenos">487</span></a><span class="k">def</span> <span class="nf">find_crossing</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
</span><span id="find_crossing-488"><a href="#find_crossing-488"><span class="linenos">488</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;the smallest M such that array[m] &lt; cutoff for all m &gt; M&quot;&quot;&quot;</span>
</span><span id="find_crossing-489"><a href="#find_crossing-489"><span class="linenos">489</span></a>
</span><span id="find_crossing-490"><a href="#find_crossing-490"><span class="linenos">490</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
</span><span id="find_crossing-491"><a href="#find_crossing-491"><span class="linenos">491</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;carry = (, 1 if (array[i] &gt; cutoff for all i &lt; current index) else 0&quot;&quot;&quot;</span>
</span><span id="find_crossing-492"><a href="#find_crossing-492"><span class="linenos">492</span></a>        <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">element</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
</span><span id="find_crossing-493"><a href="#find_crossing-493"><span class="linenos">493</span></a>        <span class="n">never_been_below</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">above_threshold</span>  <span class="c1">#1 if (array[i] &gt; cutoff for all i &lt; current index) else 0</span>
</span><span id="find_crossing-494"><a href="#find_crossing-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">carry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">never_been_below</span><span class="p">,</span> <span class="n">never_been_below</span><span class="p">),</span> <span class="n">above_threshold</span>
</span><span id="find_crossing-495"><a href="#find_crossing-495"><span class="linenos">495</span></a>
</span><span id="find_crossing-496"><a href="#find_crossing-496"><span class="linenos">496</span></a>    <span class="n">state</span><span class="p">,</span> <span class="n">track</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xs</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
</span><span id="find_crossing-497"><a href="#find_crossing-497"><span class="linenos">497</span></a>
</span><span id="find_crossing-498"><a href="#find_crossing-498"><span class="linenos">498</span></a>    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="find_crossing-499"><a href="#find_crossing-499"><span class="linenos">499</span></a>    <span class="c1">#return jnp.sum(track) #total number of indices for which array[m] &lt; cutoff</span>
</span></pre></div>


            <div class="docstring"><p>the smallest M such that array[m] &lt; cutoff for all m &gt; M</p>
</div>


                </section>
                <section id="point_reduction">
                            <input id="point_reduction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">point_reduction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">num_points</span>, </span><span class="param"><span class="n">reduction_factor</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="point_reduction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#point_reduction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="point_reduction-503"><a href="#point_reduction-503"><span class="linenos">503</span></a><span class="k">def</span> <span class="nf">point_reduction</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="p">):</span>
</span><span id="point_reduction-504"><a href="#point_reduction-504"><span class="linenos">504</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;reduces the number of points for plotting purposes&quot;&quot;&quot;</span>
</span><span id="point_reduction-505"><a href="#point_reduction-505"><span class="linenos">505</span></a>
</span><span id="point_reduction-506"><a href="#point_reduction-506"><span class="linenos">506</span></a>    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_points</span> <span class="o">//</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
</span><span id="point_reduction-507"><a href="#point_reduction-507"><span class="linenos">507</span></a>                              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">num_points</span> <span class="o">//</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)))</span>
</span><span id="point_reduction-508"><a href="#point_reduction-508"><span class="linenos">508</span></a>    <span class="k">return</span> <span class="n">indexes</span>
</span></pre></div>


            <div class="docstring"><p>reduces the number of points for plotting purposes</p>
</div>


                </section>
    </main>
</body>
</html>